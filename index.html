<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Stabolut â€” Financial Dashboard</title>
<!-- Chart.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"
  integrity="sha512-CQBWl4fJHWbryGE+Pc3UJWW1h6zdKqUsZpBlNmJA8iyr1hKP8QCQOomc4uBuZJWMjBnDMbYh7qe5O5mI5MvQ=="
  crossorigin="anonymous"></script>
<!-- SheetJS for Excel export -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"
  crossorigin="anonymous"></script>
<!-- Google Fonts -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:opsz,wght@9..40,300;9..40,400;9..40,500;9..40,600;9..40,700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
<style>
:root {
  --purple: #7B2FBE;
  --purple-l: #9B59D0;
  --purple-pale: #F3EAFB;
  --purple-mid: #E0C8F5;
  --green: #27AE60;
  --green-pale: #E8F8EF;
  --red: #E74C3C;
  --red-pale: #FDECEA;
  --gold: #F39C12;
  --gold-pale: #FEF9E7;
  --teal: #1ABC9C;
  --g100: #F8F9FA;
  --g200: #EEF0F3;
  --g300: #DEE2E9;
  --g500: #8892A0;
  --g700: #4A5568;
  --g900: #1A202C;
  --bg: #F5F6FB;
  --white: #FFFFFF;
  --shadow: 0 2px 12px rgba(123,47,190,.08);
  --shadow-h: 0 6px 28px rgba(123,47,190,.16);
  --r: 16px;
  --rs: 10px;
  --font: 'DM Sans', system-ui, sans-serif;
  --mono: 'Space Mono', monospace;
}
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%}
body{font-family:var(--font);background:var(--bg);color:var(--g900);min-height:100vh}

/* â”€â”€ LAYOUT â”€â”€ */
.layout{display:flex;min-height:100vh}

/* â”€â”€ SIDEBAR â”€â”€ */
.sidebar{
  width:230px;min-width:230px;background:var(--white);
  border-right:1.5px solid var(--g200);
  display:flex;flex-direction:column;
  position:sticky;top:0;height:100vh;overflow-y:auto;z-index:100;
  transition:transform .25s
}
.sb-logo{padding:24px 20px 16px;border-bottom:1px solid var(--g200)}
.sb-logo .wordmark{
  font-size:26px;font-weight:900;letter-spacing:-1px;
  color:var(--purple);font-family:var(--font);line-height:1
}
.sb-logo .wordmark span{color:var(--purple-l)}
.sb-badge{
  display:inline-block;margin-top:8px;
  font-size:10px;font-weight:700;letter-spacing:1px;text-transform:uppercase;
  color:var(--purple);background:var(--purple-pale);padding:3px 8px;border-radius:20px
}
.sb-nav{padding:12px 10px;flex:1}
.nav-sep{font-size:10px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;
  color:var(--g500);padding:14px 10px 4px}
.nav-btn{
  display:flex;align-items:center;gap:10px;
  width:100%;padding:10px 10px;border-radius:var(--rs);
  cursor:pointer;font-size:13.5px;font-weight:500;color:var(--g700);
  transition:all .15s;border:none;background:none;text-align:left
}
.nav-btn:hover{background:var(--purple-pale);color:var(--purple)}
.nav-btn.active{background:var(--purple);color:#fff}
.nav-btn .ic{width:20px;text-align:center;font-size:15px}

/* â”€â”€ MAIN â”€â”€ */
.main{flex:1;min-width:0;display:flex;flex-direction:column}

/* â”€â”€ TOPBAR â”€â”€ */
.topbar{
  background:var(--white);border-bottom:1.5px solid var(--g200);
  padding:14px 28px;display:flex;align-items:center;
  justify-content:space-between;position:sticky;top:0;z-index:50;gap:12px
}
.topbar-left{display:flex;align-items:center;gap:12px}
.topbar h1{font-size:18px;font-weight:700;color:var(--g900)}
.topbar .sub{font-size:12px;color:var(--g500);margin-top:2px}
.topbar-right{display:flex;gap:8px;align-items:center;flex-wrap:wrap}

.btn{
  display:inline-flex;align-items:center;gap:6px;
  padding:8px 16px;border-radius:var(--rs);
  font-size:13px;font-weight:600;cursor:pointer;border:none;
  transition:all .15s;font-family:var(--font)
}
.btn-pri{background:var(--purple);color:#fff}
.btn-pri:hover{background:var(--purple-l);box-shadow:0 4px 16px rgba(123,47,190,.3)}
.btn-out{background:var(--white);color:var(--purple);border:1.5px solid var(--purple)}
.btn-out:hover{background:var(--purple-pale)}
.btn-ghost{background:var(--g100);color:var(--g700)}
.btn-ghost:hover{background:var(--g200)}
.hamburger{display:none;background:none;border:none;cursor:pointer;font-size:22px;color:var(--g700);padding:4px}

/* â”€â”€ PAGES â”€â”€ */
/* Use visibility trick instead of display:none so charts can measure */
.page{display:none;padding:24px 28px 40px;animation:fadeIn .2s ease}
.page.active{display:block}
@keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}

/* â”€â”€ KPI GRID â”€â”€ */
.kpi-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(185px,1fr));gap:14px;margin-bottom:22px}
.kpi-card{
  background:var(--white);border-radius:var(--r);padding:18px 20px;
  border:1px solid var(--g200);box-shadow:var(--shadow);
  position:relative;overflow:hidden;transition:all .2s
}
.kpi-card:hover{box-shadow:var(--shadow-h);transform:translateY(-2px)}
.kpi-card::before{
  content:'';position:absolute;top:0;left:0;right:0;height:4px;
  border-radius:var(--r) var(--r) 0 0
}
.kpi-card.c-pu::before{background:linear-gradient(90deg,var(--purple),var(--purple-l))}
.kpi-card.c-gr::before{background:linear-gradient(90deg,#27AE60,#2ECC71)}
.kpi-card.c-re::before{background:linear-gradient(90deg,#E74C3C,#F1948A)}
.kpi-card.c-go::before{background:linear-gradient(90deg,#F39C12,#F7DC6F)}
.kpi-card.c-te::before{background:linear-gradient(90deg,#1ABC9C,#48C9B0)}
.kpi-lbl{font-size:11px;font-weight:700;color:var(--g500);text-transform:uppercase;letter-spacing:.5px}
.kpi-val{font-size:24px;font-weight:700;color:var(--g900);margin:6px 0 3px;font-family:var(--mono)}
.kpi-dlt{font-size:12px;font-weight:600}
.kpi-dlt.pos{color:var(--green)}
.kpi-dlt.neg{color:var(--red)}
.kpi-ic{position:absolute;right:16px;top:16px;font-size:26px;opacity:.13}

/* â”€â”€ CHARTS â”€â”€ */
.charts-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:18px;margin-bottom:20px}
.charts-grid .wide{grid-column:1/-1}
.chart-card{background:var(--white);border-radius:var(--r);padding:22px;border:1px solid var(--g200);box-shadow:var(--shadow)}
.chart-hdr{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:16px}
.chart-title{font-size:14px;font-weight:700;color:var(--g900)}
.chart-sub{font-size:11px;color:var(--g500);margin-top:2px}
.chart-wrap{position:relative;height:230px}

/* â”€â”€ SECTION TITLE â”€â”€ */
.sec-title{
  font-size:16px;font-weight:700;color:var(--g900);
  margin:24px 0 14px;display:flex;align-items:center;gap:10px
}
.sec-title::after{content:'';flex:1;height:2px;background:var(--g200)}

/* â”€â”€ CARD â”€â”€ */
.card{background:var(--white);border-radius:var(--r);padding:22px;border:1px solid var(--g200);box-shadow:var(--shadow)}
.card-title{font-size:12px;font-weight:700;letter-spacing:.5px;text-transform:uppercase;color:var(--g500);margin-bottom:12px}
.card.dashed{border:2px dashed var(--purple-l);background:var(--purple-pale)}

/* â”€â”€ TABLE â”€â”€ */
.table-wrap{overflow-x:auto;border-radius:var(--rs)}
table{width:100%;border-collapse:collapse;font-size:12.5px}
thead th{
  background:var(--purple-pale);color:var(--purple);
  font-weight:700;font-size:10.5px;text-transform:uppercase;letter-spacing:.4px;
  padding:9px 12px;text-align:right;white-space:nowrap
}
thead th:first-child{text-align:left}
tbody tr{border-bottom:1px solid var(--g200);transition:background .1s}
tbody tr:hover{background:var(--g100)}
tbody td{padding:9px 12px;text-align:right;color:var(--g700);white-space:nowrap}
tbody td:first-child{text-align:left;font-weight:600;color:var(--g900)}
.td-pos{color:var(--green)!important;font-weight:700}
.td-neg{color:var(--red)!important;font-weight:700}
.td-pu{color:var(--purple)!important;font-weight:700}
.td-bold{font-weight:700}
tr.row-total{background:var(--g100)}
tr.row-total td{font-weight:700;border-top:2px solid var(--purple-mid)}

/* â”€â”€ INPUTS â”€â”€ */
.inputs-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:12px}
.inp-group{display:flex;flex-direction:column;gap:4px}
.inp-lbl{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.4px;color:var(--g700)}
.inp-wrap{position:relative}
.inp-prefix{position:absolute;left:10px;top:50%;transform:translateY(-50%);font-size:13px;font-weight:600;color:var(--g500);pointer-events:none}
.inp-field{
  width:100%;padding:9px 12px;border:1.5px solid var(--g300);
  border-radius:var(--rs);font-family:var(--font);font-size:13px;
  color:var(--g900);background:var(--white);outline:none;transition:border-color .15s,box-shadow .15s
}
.inp-field.has-prefix{padding-left:26px}
.inp-field:focus{border-color:var(--purple);box-shadow:0 0 0 3px rgba(123,47,190,.1)}
select.inp-field{cursor:pointer}

.alert{
  background:var(--purple-pale);border-left:4px solid var(--purple);
  border-radius:var(--rs);padding:11px 14px;font-size:13px;color:var(--purple);
  margin-bottom:18px;font-weight:500;line-height:1.5
}
.recalc-note{
  background:var(--g100);border:1px solid var(--g200);border-radius:var(--rs);
  padding:9px 12px;font-size:12px;color:var(--g700);margin-top:12px;
  display:flex;align-items:center;gap:6px
}
.actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:16px}

/* â”€â”€ FOOTER â”€â”€ */
.footer{
  background:var(--white);border-top:1px solid var(--g200);
  padding:12px 28px;font-size:11px;color:var(--g500);
  display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:6px
}

/* â”€â”€ RESPONSIVE â”€â”€ */
@media(max-width:900px){
  .sidebar{position:fixed;transform:translateX(-100%)}
  .sidebar.open{transform:translateX(0);box-shadow:0 0 40px rgba(0,0,0,.2)}
  .hamburger{display:block}
  .page{padding:16px 14px 32px}
  .topbar{padding:12px 14px}
  .charts-grid{grid-template-columns:1fr}
}
@media(max-width:580px){
  .kpi-grid{grid-template-columns:repeat(2,1fr)}
  .inputs-grid{grid-template-columns:repeat(2,1fr)}
  .kpi-val{font-size:20px}
}
</style>
</head>
<body>
<div class="layout">

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SIDEBAR â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<nav class="sidebar" id="sidebar">
  <div class="sb-logo">
    <div class="wordmark">sta<span>bo</span>lut</div>
    <div class="sb-badge">$10M Round Â· 2026â€“2029</div>
  </div>
  <div class="sb-nav">
    <div class="nav-sep">Principal</div>
    <button class="nav-btn active" data-page="dashboard"><span class="ic">ğŸ“Š</span>Dashboard</button>
    <button class="nav-btn" data-page="users"><span class="ic">ğŸ‘¥</span>Usuarios / Clientes</button>
    <button class="nav-btn" data-page="costs"><span class="ic">ğŸ’°</span>Costes Operativos</button>
    <button class="nav-btn" data-page="taxes"><span class="ic">ğŸ›ï¸</span>Impuestos</button>
    <div class="nav-sep">AnÃ¡lisis</div>
    <button class="nav-btn" data-page="kpis"><span class="ic">ğŸ¯</span>KPIs EstratÃ©gicos</button>
    <button class="nav-btn" data-page="forecast"><span class="ic">ğŸ“ˆ</span>Forecast 5 AÃ±os</button>
    <div class="nav-sep">Exportar</div>
    <button class="nav-btn" onclick="exportExcel()"><span class="ic">ğŸ“¥</span>Excel (.xlsx)</button>
    <button class="nav-btn" onclick="exportCSV()"><span class="ic">ğŸ“„</span>CSV</button>
    <button class="nav-btn" onclick="window.print()"><span class="ic">ğŸ–¨ï¸</span>PDF / Imprimir</button>
  </div>
</nav>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• MAIN â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="main">

  <!-- TOPBAR -->
  <div class="topbar">
    <div class="topbar-left">
      <button class="hamburger" onclick="document.getElementById('sidebar').classList.toggle('open')">â˜°</button>
      <div>
        <h1 id="page-title">ğŸ“Š Overview Dashboard</h1>
        <div class="sub" id="page-sub">Escenario $10M Round Â· <span id="today-date"></span></div>
      </div>
    </div>
    <div class="topbar-right">
      <button class="btn btn-out" onclick="recalcAll()">ğŸ”„ Recalcular</button>
      <button class="btn btn-pri" onclick="exportExcel()">â¬‡ Excel</button>
      <button class="btn btn-ghost" onclick="exportCSV()">â¬‡ CSV</button>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â• PAGE: DASHBOARD â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="page-dashboard" class="page active">

    <div class="kpi-grid" id="kpi-row"></div>

    <div class="charts-grid">
      <div class="chart-card wide">
        <div class="chart-hdr">
          <div><div class="chart-title">ğŸ“ˆ Revenue vs OpEx vs Net Income â€” Trimestral</div>
          <div class="chart-sub">$000s Â· 2026â€“2029</div></div>
        </div>
        <div class="chart-wrap"><canvas id="cMain"></canvas></div>
      </div>
    </div>

    <div class="charts-grid">
      <div class="chart-card">
        <div class="chart-hdr"><div><div class="chart-title">ğŸ’ AuM / TVL Growth</div>
        <div class="chart-sub">$000s trimestral</div></div></div>
        <div class="chart-wrap"><canvas id="cAum"></canvas></div>
      </div>
      <div class="chart-card">
        <div class="chart-hdr"><div><div class="chart-title">ğŸ’° Desglose de Costes 2026</div>
        <div class="chart-sub">DistribuciÃ³n anual</div></div></div>
        <div class="chart-wrap"><canvas id="cCosts"></canvas></div>
      </div>
      <div class="chart-card">
        <div class="chart-hdr"><div><div class="chart-title">ğŸ’µ Cash Balance Evolution</div>
        <div class="chart-sub">$000s acumulado</div></div></div>
        <div class="chart-wrap"><canvas id="cCash"></canvas></div>
      </div>
    </div>

    <div class="sec-title">ğŸ“‹ P&amp;L Trimestral Completo</div>
    <div class="card" style="padding:0">
      <div class="table-wrap"><table><thead id="pl-head"></thead><tbody id="pl-body"></tbody></table></div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â• PAGE: USERS â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="page-users" class="page">
    <div class="alert">âœï¸ <strong>Modo ediciÃ³n:</strong> Modifica el nÃºmero de usuarios por trimestre. Los cambios recalcularÃ¡n automÃ¡ticamente todo el modelo (AuM, Revenue, Net Income, Cash).</div>
    <div class="card dashed" style="margin-bottom:20px">
      <div class="card-title">ğŸ‘¥ Usuarios por Trimestre â€” Entrada Manual</div>
      <div class="inputs-grid" id="user-inputs"></div>
      <div class="recalc-note">ğŸ”„ Cualquier cambio actualiza el Dashboard y KPIs al instante. El AuM se recalcula proporcionalmente a los usuarios.</div>
      <div class="actions">
        <button class="btn btn-pri" onclick="recalcAll()">ğŸ”„ Recalcular Todo</button>
        <button class="btn btn-ghost" onclick="resetUsers()">â†© Restaurar Originales</button>
      </div>
    </div>
    <div class="charts-grid">
      <div class="chart-card">
        <div class="chart-title" style="margin-bottom:14px">ğŸ‘¤ Usuarios por Trimestre</div>
        <div class="chart-wrap"><canvas id="cUsers"></canvas></div>
      </div>
      <div class="chart-card">
        <div class="chart-title" style="margin-bottom:14px">ğŸ’ AuM por Usuario ($K medio)</div>
        <div class="chart-wrap"><canvas id="cAumUser"></canvas></div>
      </div>
    </div>
    <div class="sec-title">ğŸ“Š Tabla Usuarios &amp; AuM</div>
    <div class="card" style="padding:0">
      <div class="table-wrap"><table><thead id="users-head"></thead><tbody id="users-body"></tbody></table></div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â• PAGE: COSTS â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="page-costs" class="page">
    <div class="alert">âœï¸ <strong>Ajuste de Gastos:</strong> Introduce valores adicionales (+) o ahorros (-) sobre el OpEx base. Los cambios actualizan Net Income y Cash Balance. Valores en $000s.</div>
    <div class="card dashed" style="margin-bottom:20px">
      <div class="card-title">ğŸ’¸ Ajuste Manual de Gastos por Trimestre ($000s)</div>
      <div class="inputs-grid" id="cost-inputs"></div>
      <div class="recalc-note">â„¹ï¸ Positivo = gasto adicional / Negativo = ahorro o reducciÃ³n de costes</div>
      <div class="actions">
        <button class="btn btn-pri" onclick="recalcAll()">ğŸ”„ Recalcular Todo</button>
        <button class="btn btn-ghost" onclick="resetCosts()">â†© Limpiar Ajustes</button>
      </div>
    </div>
    <div class="sec-title">ğŸ“Š Estructura de Costes Completa</div>
    <div class="card" style="padding:0">
      <div class="table-wrap"><table><thead id="costs-head"></thead><tbody id="costs-body"></tbody></table></div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â• PAGE: TAXES â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="page-taxes" class="page">
    <div class="alert">ğŸ›ï¸ <strong>Calculadora Fiscal:</strong> Configura los tipos impositivos por paÃ­s/jurisdicciÃ³n para calcular los pagos trimestrales. Solo se aplica impuesto en trimestres con Net Income positivo.</div>
    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:18px;margin-bottom:20px">
      <div class="card">
        <div class="card-title">ğŸ‡ªğŸ‡¸ EspaÃ±a â€” ParÃ¡metros Fiscales</div>
        <div class="inp-group" style="margin-bottom:10px">
          <label class="inp-lbl">Impuesto de Sociedades (%)</label>
          <div class="inp-wrap"><span class="inp-prefix">%</span>
            <input class="inp-field has-prefix" id="tax-es-corp" type="number" value="25" min="0" max="100" step=".5" oninput="recalcTax()"></div>
        </div>
        <div class="inp-group" style="margin-bottom:10px">
          <label class="inp-lbl">IVA (%)</label>
          <div class="inp-wrap"><span class="inp-prefix">%</span>
            <input class="inp-field has-prefix" id="tax-es-iva" type="number" value="21" min="0" max="30" step=".5" oninput="recalcTax()"></div>
        </div>
        <div class="inp-group" style="margin-bottom:10px">
          <label class="inp-lbl">RetenciÃ³n sobre dividendos (%)</label>
          <div class="inp-wrap"><span class="inp-prefix">%</span>
            <input class="inp-field has-prefix" id="tax-es-div" type="number" value="19" min="0" max="30" step=".5" oninput="recalcTax()"></div>
        </div>
        <div class="inp-group">
          <label class="inp-lbl">MÃ©todo pagos fraccionados</label>
          <select class="inp-field" id="tax-es-method" onchange="recalcTax()">
            <option value="0.18">MÃ©todo 1 â€” 18% cuota Ã­ntegra aÃ±o anterior</option>
            <option value="0.40" selected>MÃ©todo 2 â€” 40% resultado fiscal acumulado</option>
          </select>
        </div>
      </div>
      <div class="card">
        <div class="card-title">ğŸŒ JurisdicciÃ³n Alternativa</div>
        <div class="inp-group" style="margin-bottom:10px">
          <label class="inp-lbl">PaÃ­s / JurisdicciÃ³n</label>
          <input class="inp-field" id="tax-other-name" type="text" value="UAE / Cayman Islands" oninput="recalcTax()">
        </div>
        <div class="inp-group" style="margin-bottom:10px">
          <label class="inp-lbl">Corporate Tax (%)</label>
          <div class="inp-wrap"><span class="inp-prefix">%</span>
            <input class="inp-field has-prefix" id="tax-other-corp" type="number" value="9" min="0" max="100" step=".5" oninput="recalcTax()"></div>
        </div>
        <div class="inp-group" style="margin-bottom:10px">
          <label class="inp-lbl">Withholding Tax (%)</label>
          <div class="inp-wrap"><span class="inp-prefix">%</span>
            <input class="inp-field has-prefix" id="tax-other-wh" type="number" value="0" min="0" max="50" step=".5" oninput="recalcTax()"></div>
        </div>
        <div class="inp-group">
          <label class="inp-lbl">Tipo efectivo estimado (%)</label>
          <div class="inp-wrap"><span class="inp-prefix">%</span>
            <input class="inp-field has-prefix" id="tax-other-eff" type="number" value="9" min="0" max="100" step=".5" oninput="recalcTax()"></div>
        </div>
      </div>
      <div class="card">
        <div class="card-title">âš ï¸ Notas Fiscales Importantes</div>
        <div style="font-size:12.5px;color:var(--g700);line-height:1.75">
          <p>ğŸ‡ªğŸ‡¸ <strong>EspaÃ±a:</strong> Pagos fraccionados en abril (P1), octubre (P3) y diciembre (P11). LiquidaciÃ³n definitiva mod. 200 en julio del aÃ±o siguiente.</p><br>
          <p>ğŸ“‹ <strong>PÃ©rdidas (2026):</strong> Sin IS. Las BINs se compensan con beneficios futuros (art. 26 LIS, lÃ­mite 70%). Pendiente acumulado = $5.19M.</p><br>
          <p>ğŸŒ <strong>Internacional:</strong> Aplicar convenios de doble imposiciÃ³n. Evaluar rÃ©gimen ETVE para dividendos de subsidiarias extranjeras.</p><br>
          <p>ğŸ’¡ <strong>Crypto/Stablecoin:</strong> TributaciÃ³n segÃºn estructura societaria: rendimientos de capital mobiliario o actividad econÃ³mica.</p>
        </div>
      </div>
    </div>
    <div class="sec-title">ğŸ“Š Pagos Trimestrales de Impuestos</div>
    <div class="card" style="padding:0;margin-bottom:20px">
      <div class="table-wrap"><table><thead id="tax-head"></thead><tbody id="tax-body"></tbody></table></div>
    </div>
    <div class="charts-grid">
      <div class="chart-card">
        <div class="chart-title" style="margin-bottom:14px">ğŸ›ï¸ Carga Fiscal Estimada Anual ($000s)</div>
        <div class="chart-wrap"><canvas id="cTax"></canvas></div>
      </div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â• PAGE: KPIs â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="page-kpis" class="page">
    <div class="kpi-grid" id="kpi-strategic"></div>
    <div class="sec-title">ğŸ“Š KPIs por AÃ±o</div>
    <div class="card" style="padding:0;margin-bottom:20px">
      <div class="table-wrap"><table><thead id="kpis-head"></thead><tbody id="kpis-body"></tbody></table></div>
    </div>
    <div class="charts-grid">
      <div class="chart-card">
        <div class="chart-title" style="margin-bottom:14px">ğŸ“Š EBITDA Margin por AÃ±o (%)</div>
        <div class="chart-wrap"><canvas id="cEbitda"></canvas></div>
      </div>
      <div class="chart-card">
        <div class="chart-title" style="margin-bottom:14px">ğŸ¯ Revenue Growth Rate (YoY %)</div>
        <div class="chart-wrap"><canvas id="cGrowth"></canvas></div>
      </div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â• PAGE: FORECAST â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="page-forecast" class="page">
    <div class="alert">ğŸ“… Forecast completo 5 aÃ±os (2026â€“2030). Datos reales hasta Q4 2029 + proyecciÃ³n 2030 calculada con +30% en Revenue.</div>
    <div class="kpi-grid" id="forecast-kpis"></div>
    <div class="sec-title">ğŸ“ˆ ProyecciÃ³n 5 AÃ±os â€” Revenue, Net Income &amp; Cash</div>
    <div class="chart-card" style="margin-bottom:20px">
      <div class="chart-wrap" style="height:300px"><canvas id="cForecast"></canvas></div>
    </div>
    <div class="sec-title">ğŸ“‹ Tabla Anual Completa 2026â€“2030</div>
    <div class="card" style="padding:0">
      <div class="table-wrap"><table><thead id="fc-head"></thead><tbody id="fc-body"></tbody></table></div>
    </div>
  </div>

  <div class="footer">
    <span>Â© 2026 Stabolut Financial Model v3.1 Â· Confidencial Â· Para uso interno e inversores</span>
    <span>Datos en $000s Â· Escenario $10M Round Â· <span id="footer-date"></span></span>
  </div>
</div><!-- /main -->
</div><!-- /layout -->

<script>
'use strict';
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// BASE DATA ($ 000s)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const QQ = ['Q1 2026','Q2 2026','Q3 2026','Q4 2026',
            'Q1 2027','Q2 2027','Q3 2027','Q4 2027',
            'Q1 2028','Q2 2028','Q3 2028','Q4 2028',
            'Q1 2029','Q2 2029','Q3 2029','Q4 2029'];

const BASE_USERS = [20,100,200,200,600,840,1176,1529,1987,2385,2862,3434,3778,4155,4571,5028];
const BASE_AUM   = [20000,100000,200000,200000,600000,840000,1176000,1528800,1987440,2384928,2861914,3434296,3777726,4155499,4571048,5028153];
const APR        = [.30,.30,.29,.29,.28,.27,.26,.25,.24,.23,.21,.20,.19,.18,.16,.16];
const CAP_RAISE  = [5000,5000,0,0,0,0,0,0,0,0,0,0,0,0,0,0];
const MA         = [-1000,-2000,-1000,-1000,-2000,-4000,-4000,-4000,-4000,-4000,-4000,-4000,-4000,-4000,-4000,-4000];

const BASE_COSTS = {
  'Engineering & Dev':    [300,400,500,500,500,500,500,500,600,600,600,600,600,600,600,600],
  'BD & Partnerships':    [140,150,150,150,150,150,150,150,150,150,150,150,150,150,150,150],
  'Marketing & Growth':   [2000,1500,2000,2500,2500,2500,2500,2500,2000,2000,1500,1500,1500,1500,1500,1500],
  'Compliance & Legal':   [500,500,400,400,400,400,250,250,250,250,250,250,250,250,250,250],
  'Ops & Infrastructure': [120,140,150,170,190,200,200,200,200,200,200,200,200,200,200,200],
  'G&A':                  [30,40,50,60,70,70,70,70,70,70,70,70,70,70,70,70]
};

// â”€â”€ Mutable state
let userDelta = Array(16).fill(0);   // delta from base users
let costAdj   = Array(16).fill(0);   // extra cost $K per quarter

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// COMPUTED
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function users(){ return BASE_USERS.map((u,i)=>Math.max(0, u+userDelta[i])); }
function aum(){
  const u=users();
  return u.map((v,i)=>BASE_USERS[i]>0 ? Math.round(BASE_AUM[i]*(v/BASE_USERS[i])) : 0);
}
function revenue(){
  return aum().map((a,i)=>Math.round(a*APR[i]*0.20/4));
}
function opex(){
  return QQ.map((_,i)=>Object.values(BASE_COSTS).reduce((s,arr)=>s+arr[i],0)+costAdj[i]);
}
function netIncome(){ const r=revenue(),o=opex(); return r.map((v,i)=>v-o[i]); }
function cashBalance(){
  const net=netIncome(); let prev=0; const out=[];
  for(let i=0;i<16;i++){ prev+=net[i]+CAP_RAISE[i]+MA[i]; out.push(Math.round(prev)); }
  return out;
}
function annSum(arr,yr){ const s=yr*4; return arr.slice(s,s+4).reduce((a,b)=>a+b,0); }

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// FORMAT
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function fmt(v){
  if(v===null||v===undefined) return 'â€”';
  const abs=Math.abs(v);
  const sign=v<0?'-':'';
  if(abs>=1000000) return sign+'$'+(abs/1000000).toFixed(1)+'M';
  if(abs>=1000)    return sign+'$'+(abs/1000).toFixed(0)+'K';
  return sign+'$'+abs.toFixed(0);
}
function fmtK(v){
  if(v===null||v===undefined) return 'â€”';
  const neg=v<0; const abs=Math.abs(Math.round(v));
  return (neg?'(':'')+' $'+abs.toLocaleString('es-ES')+(neg?')':'');
}
function neg(v){ return v<0?'td-neg':v>0?'td-pos':''; }

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// NAVIGATION â€” lazy chart init on tab switch
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const PAGE_TITLES={
  dashboard:'ğŸ“Š Overview Dashboard',
  users:'ğŸ‘¥ Usuarios / Clientes',
  costs:'ğŸ’° Costes Operativos',
  taxes:'ğŸ›ï¸ Calculadora Fiscal',
  kpis:'ğŸ¯ KPIs EstratÃ©gicos',
  forecast:'ğŸ“ˆ Forecast 5 AÃ±os'
};
let currentPage='dashboard';

document.querySelectorAll('.nav-btn[data-page]').forEach(btn=>{
  btn.addEventListener('click',()=>navTo(btn.dataset.page));
});

function navTo(id){
  if(id===currentPage) return;
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('page-'+id).classList.add('active');
  document.querySelector(`.nav-btn[data-page="${id}"]`).classList.add('active');
  document.getElementById('page-title').textContent=PAGE_TITLES[id]||id;
  currentPage=id;
  // Re-render charts for newly visible page (fixes display:none sizing issue)
  requestAnimationFrame(()=>renderChartsFor(id));
}

function renderChartsFor(id){
  if(id==='dashboard'){ renderMainChart(); renderAuMChart(); renderCostsChart(); renderCashChart(); }
  if(id==='users')     { renderUsersChart(); renderAuMUserChart(); }
  if(id==='kpis')      { renderEbitdaChart(); renderGrowthChart(); }
  if(id==='taxes')     { recalcTax(); }
  if(id==='forecast')  { renderForecastChart(); }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// BUILD INPUT WIDGETS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildUserInputs(){
  const u=users();
  document.getElementById('user-inputs').innerHTML=QQ.map((q,i)=>`
    <div class="inp-group">
      <label class="inp-lbl">${q}</label>
      <input class="inp-field" type="number" id="ui${i}" value="${u[i]}" min="0" step="10"
        oninput="userDelta[${i}]=Math.max(0,parseInt(this.value)||0)-${BASE_USERS[i]};recalcAll()">
    </div>`).join('');
}

function buildCostInputs(){
  document.getElementById('cost-inputs').innerHTML=QQ.map((q,i)=>`
    <div class="inp-group">
      <label class="inp-lbl">${q}</label>
      <div class="inp-wrap"><span class="inp-prefix">$</span>
        <input class="inp-field has-prefix" type="number" id="ci${i}" value="${costAdj[i]}" step="10"
          oninput="costAdj[${i}]=parseFloat(this.value)||0;recalcAll()">
      </div>
    </div>`).join('');
}

function resetUsers(){ userDelta=Array(16).fill(0); buildUserInputs(); recalcAll(); }
function resetCosts(){ costAdj=Array(16).fill(0); buildCostInputs(); recalcAll(); }

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// RENDER KPI CARDS (dashboard)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderKPIRow(){
  const r=revenue(),o=opex(),n=netIncome(),c=cashBalance(),u=users(),a=aum();
  const y0r=annSum(r,0), y0o=annSum(o,0), y0n=annSum(n,0);
  const y1r=annSum(r,1);
  const pct=y0r>0?((y1r-y0r)/Math.abs(y0r)*100).toFixed(0):0;
  const bkIdx=n.findIndex(v=>v>0);
  document.getElementById('kpi-row').innerHTML=`
    <div class="kpi-card c-pu"><span class="kpi-ic">ğŸ’</span>
      <div class="kpi-lbl">AuM/TVL Total 2026</div>
      <div class="kpi-val">${fmt(annSum(a,0))}</div>
      <div class="kpi-dlt pos">â†‘ Escenario $10M</div>
    </div>
    <div class="kpi-card c-gr"><span class="kpi-ic">ğŸ“ˆ</span>
      <div class="kpi-lbl">Protocol Revenue 2026</div>
      <div class="kpi-val">${fmt(y0r)}</div>
      <div class="kpi-dlt pos">+${pct}% YoY vs 2027</div>
    </div>
    <div class="kpi-card c-re"><span class="kpi-ic">ğŸ’¸</span>
      <div class="kpi-lbl">Total OpEx 2026</div>
      <div class="kpi-val">${fmt(y0o)}</div>
      <div class="kpi-dlt neg">â†“ InversiÃ³n inicial</div>
    </div>
    <div class="kpi-card c-go"><span class="kpi-ic">ğŸ¦</span>
      <div class="kpi-lbl">Net Income 2026</div>
      <div class="kpi-val">${fmt(y0n)}</div>
      <div class="kpi-dlt ${y0n>=0?'pos':'neg'}">${y0n>=0?'â†‘ Beneficio':'â†“ InversiÃ³n arranque'}</div>
    </div>
    <div class="kpi-card c-te"><span class="kpi-ic">ğŸ’µ</span>
      <div class="kpi-lbl">Cash Balance Q4 2026</div>
      <div class="kpi-val">${fmt(c[3])}</div>
      <div class="kpi-dlt ${c[3]>=0?'pos':'neg'}">+ Capital raise $10M</div>
    </div>
    <div class="kpi-card c-pu"><span class="kpi-ic">ğŸ‘¤</span>
      <div class="kpi-lbl">Usuarios Q4 2026</div>
      <div class="kpi-val">${u[3].toLocaleString()}</div>
      <div class="kpi-dlt pos">Breakeven: ${bkIdx>=0?QQ[bkIdx]:'TBD'}</div>
    </div>`;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// RENDER P&L TABLE
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderPLTable(){
  const r=revenue(),o=opex(),n=netIncome(),c=cashBalance(),a=aum(),u=users();
  const thCells=QQ.map(q=>`<th>${q.replace(' ','<br>')}</th>`).join('');
  document.getElementById('pl-head').innerHTML=`<tr><th>Partida ($000s)</th>${thCells}</tr>`;

  const rows=[
    {lbl:'ğŸ‘¥ Usuarios',        vals:u,         cf:()=>''},
    {lbl:'ğŸ’ AuM / TVL',       vals:a,         cf:()=>'td-pu'},
    {lbl:'APR (%)',             vals:APR.map(v=>(v*100).toFixed(0)+'%'), cf:()=>'',raw:true},
    {lbl:'âœ… Protocol Revenue', vals:r,         cf:()=>'td-pos'},
    {lbl:'Total OpEx',          vals:o,         cf:()=>'td-neg'},
    {lbl:'ğŸ“Š NET INCOME',       vals:n,         cf:(v)=>neg(v),bold:true},
    {lbl:'Capital Raise',       vals:CAP_RAISE, cf:(v)=>v?'td-pu':''},
    {lbl:'M&A',                 vals:MA,        cf:()=>'td-neg'},
    {lbl:'ğŸ’µ Cash Balance',     vals:c,         cf:(v)=>neg(v),bold:true}
  ];

  document.getElementById('pl-body').innerHTML=rows.map(row=>{
    const cells=row.vals.map((v,i)=>{
      const cl=row.cf(v); const disp=row.raw?v:fmtK(v);
      return `<td class="${cl}">${disp}</td>`;
    }).join('');
    const bold=row.bold?'font-weight:700':'';
    return `<tr style="${bold}"><td>${row.lbl}</td>${cells}</tr>`;
  }).join('');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// RENDER COSTS TABLE
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderCostsTable(){
  const o=opex();
  const qShort=QQ.map(q=>q.slice(0,2)+q.slice(-2));
  const thCells=qShort.map(q=>`<th>${q}</th>`).join('');
  document.getElementById('costs-head').innerHTML=`<tr><th>Partida ($000s)</th>${thCells}<th>Total 26</th><th>Total 27</th><th>Total 28</th><th>Total 29</th></tr>`;

  let rows='';
  for(const[k,v] of Object.entries(BASE_COSTS)){
    const cells=v.map(x=>`<td>${fmtK(x)}</td>`).join('');
    const t=[0,1,2,3].map(y=>annSum(v,y));
    rows+=`<tr><td>${k}</td>${cells}${t.map(x=>`<td class="td-neg">${fmtK(x)}</td>`).join('')}</tr>`;
  }
  // Adjustments row
  const adjCells=costAdj.map((v,i)=>`<td class="${v>0?'td-neg':v<0?'td-pos':''}">${v!==0?fmtK(v):'â€”'}</td>`).join('');
  const adjT=[0,1,2,3].map(y=>annSum(costAdj,y));
  rows+=`<tr style="background:var(--purple-pale)"><td>âœï¸ Ajustes Manuales</td>${adjCells}${adjT.map(x=>`<td class="${x>0?'td-neg':x<0?'td-pos':''}">${x!==0?fmtK(x):'â€”'}</td>`).join('')}</tr>`;
  // Total row
  const totCells=o.map(v=>`<td class="td-neg"><strong>${fmtK(v)}</strong></td>`).join('');
  const totT=[0,1,2,3].map(y=>annSum(o,y));
  rows+=`<tr class="row-total"><td>TOTAL OpEx</td>${totCells}${totT.map(x=>`<td class="td-neg">${fmtK(x)}</td>`).join('')}</tr>`;
  document.getElementById('costs-body').innerHTML=rows;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// RENDER USERS TABLE
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderUsersTable(){
  const u=users(),a=aum(),r=revenue();
  const thCells=QQ.map(q=>`<th>${q.replace(' ','<br>')}</th>`).join('');
  document.getElementById('users-head').innerHTML=`<tr><th>MÃ©trica</th>${thCells}</tr>`;
  const rows=[
    {lbl:'ğŸ‘¥ Usuarios',cf:()=>''},
    {lbl:'ğŸ’ AuM/TVL ($K)',cf:()=>'td-pu'},
    {lbl:'ğŸ“ˆ Revenue ($K)',cf:()=>'td-pos'}
  ];
  const data=[u,a,r];
  document.getElementById('users-body').innerHTML=rows.map((row,ri)=>{
    const cells=data[ri].map((v,i)=>`<td class="${row.cf(v)}">${ri===0?v.toLocaleString():fmtK(v)}</td>`).join('');
    return `<tr><td>${row.lbl}</td>${cells}</tr>`;
  }).join('');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// RENDER KPIs TABLE & CARDS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderKPIsPage(){
  const r=revenue(),o=opex(),n=netIncome(),a=aum(),u=users(),c=cashBalance();
  const yrs=['2026','2027','2028','2029'];
  const Y=yrs.map((_,i)=>({
    rev:annSum(r,i),opex:annSum(o,i),net:annSum(n,i),
    aum:Math.max(...a.slice(i*4,i*4+4)),
    usr:Math.max(...u.slice(i*4,i*4+4)),
    cash:c[i*4+3]
  }));
  const bkIdx=n.findIndex(v=>v>0);

  // Strategic KPI cards
  document.getElementById('kpi-strategic').innerHTML=`
    <div class="kpi-card c-pu"><span class="kpi-ic">ğŸš€</span>
      <div class="kpi-lbl">Breakeven Quarter</div>
      <div class="kpi-val" style="font-size:18px">${bkIdx>=0?QQ[bkIdx]:'TBD'}</div>
      <div class="kpi-dlt pos">Primer trimestre positivo</div>
    </div>
    <div class="kpi-card c-gr"><span class="kpi-ic">ğŸ’°</span>
      <div class="kpi-lbl">Revenue 2027</div>
      <div class="kpi-val">${fmt(Y[1].rev)}</div>
      <div class="kpi-dlt pos">â†‘ +${((Y[1].rev-Y[0].rev)/Math.abs(Y[0].rev)*100).toFixed(0)}% vs 2026</div>
    </div>
    <div class="kpi-card c-go"><span class="kpi-ic">ğŸ¯</span>
      <div class="kpi-lbl">Max Cash Balance</div>
      <div class="kpi-val">${fmt(Math.max(...c))}</div>
      <div class="kpi-dlt pos">En ${QQ[c.indexOf(Math.max(...c))]}</div>
    </div>
    <div class="kpi-card c-te"><span class="kpi-ic">ğŸ‘¥</span>
      <div class="kpi-lbl">Usuarios 2029</div>
      <div class="kpi-val">${Y[3].usr.toLocaleString()}</div>
      <div class="kpi-dlt pos">â†‘ +${((Y[3].usr-Y[0].usr)/Y[0].usr*100).toFixed(0)}% vs 2026</div>
    </div>`;

  // KPIs table
  document.getElementById('kpis-head').innerHTML=`<tr><th>KPI</th>${yrs.map(y=>`<th>${y}</th>`).join('')}<th>CAGR 26â†’29</th></tr>`;
  const kpiRows=[
    {lbl:'ğŸ“ˆ Revenue ($K)',  vals:Y.map(y=>fmtK(y.rev)), cagr:Y[3].rev/Y[0].rev, cls:Y.map(()=>'td-pos')},
    {lbl:'ğŸ’¸ OpEx ($K)',     vals:Y.map(y=>fmtK(y.opex)),cagr:Y[3].opex/Y[0].opex,cls:Y.map(()=>'td-neg')},
    {lbl:'ğŸ“Š Net Income ($K)',vals:Y.map(y=>fmtK(y.net)),cagr:null,cls:Y.map(y=>neg(y.net))},
    {lbl:'EBITDA Margin',   vals:Y.map(y=>y.rev>0?(y.net/y.rev*100).toFixed(1)+'%':'N/A'),cagr:null,cls:Y.map(()=>'')},
    {lbl:'ğŸ’ AuM Peak ($K)', vals:Y.map(y=>fmtK(y.aum)),cagr:Y[3].aum/Y[0].aum,cls:Y.map(()=>'td-pu')},
    {lbl:'ğŸ‘¥ Peak Users',    vals:Y.map(y=>y.usr.toLocaleString()),cagr:Y[3].usr/Y[0].usr,cls:Y.map(()=>'')},
    {lbl:'ğŸ’µ Cash YE ($K)',  vals:Y.map(y=>fmtK(y.cash)),cagr:null,cls:Y.map(y=>neg(y.cash))}
  ];
  document.getElementById('kpis-body').innerHTML=kpiRows.map(row=>{
    const cells=row.vals.map((v,i)=>`<td class="${row.cls[i]}">${v}</td>`).join('');
    const cagr=row.cagr!==null?`<td>${row.cagr>0?((Math.pow(row.cagr,1/3)-1)*100).toFixed(0)+'%':'N/A'}</td>`:'<td>â€”</td>';
    return `<tr><td>${row.lbl}</td>${cells}${cagr}</tr>`;
  }).join('');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// RENDER FORECAST PAGE
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderForecastPage(){
  const r=revenue(),o=opex(),n=netIncome(),a=aum(),u=users(),c=cashBalance();
  const Y=[0,1,2,3].map(i=>({
    rev:annSum(r,i),opex:annSum(o,i),net:annSum(n,i),
    aum:Math.max(...a.slice(i*4,i*4+4)),
    usr:Math.max(...u.slice(i*4,i*4+4)),
    cash:c[i*4+3]
  }));
  // 2030 projection
  const rev30=Math.round(Y[3].rev*1.30);
  const opex30=Math.round(Y[3].opex*1.05);
  const net30=rev30-opex30;
  const aum30=Math.round(Y[3].aum*1.40);
  const usr30=Math.round(Y[3].usr*1.35);
  const cash30=c[15]+net30+MA[15];
  const E={rev:rev30,opex:opex30,net:net30,aum:aum30,usr:usr30,cash:cash30};

  // KPI summary
  const totalRev5y=Y.reduce((s,y)=>s+y.rev,0)+rev30;
  document.getElementById('forecast-kpis').innerHTML=`
    <div class="kpi-card c-pu"><span class="kpi-ic">ğŸ†</span>
      <div class="kpi-lbl">Revenue Total 5 AÃ±os</div>
      <div class="kpi-val">${fmt(totalRev5y)}</div>
    </div>
    <div class="kpi-card c-gr"><span class="kpi-ic">ğŸ’°</span>
      <div class="kpi-lbl">Net Income 2030E</div>
      <div class="kpi-val">${fmt(net30)}</div>
      <div class="kpi-dlt pos">â†‘ +30% proyecciÃ³n Revenue</div>
    </div>
    <div class="kpi-card c-go"><span class="kpi-ic">ğŸ’</span>
      <div class="kpi-lbl">AuM 2030E</div>
      <div class="kpi-val">${fmt(aum30)}</div>
    </div>
    <div class="kpi-card c-te"><span class="kpi-ic">ğŸ‘¥</span>
      <div class="kpi-lbl">Usuarios 2030E</div>
      <div class="kpi-val">${usr30.toLocaleString()}</div>
    </div>`;

  // Table
  document.getElementById('fc-head').innerHTML='<tr><th>MÃ©trica ($000s)</th><th>2026</th><th>2027</th><th>2028</th><th>2029</th><th>2030E ğŸ”®</th></tr>';
  const fcRows=[
    {lbl:'ğŸ“ˆ Protocol Revenue',v:Y.map(y=>y.rev).concat([E.rev]),cls:'td-pos'},
    {lbl:'ğŸ’¸ Total OpEx',      v:Y.map(y=>y.opex).concat([E.opex]),cls:'td-neg'},
    {lbl:'ğŸ“Š Net Income',      v:Y.map(y=>y.net).concat([E.net]),clsFn:true},
    {lbl:'ğŸ’µ Cash Balance YE', v:Y.map(y=>y.cash).concat([E.cash]),clsFn:true},
    {lbl:'ğŸ’ AuM Peak',        v:Y.map(y=>y.aum).concat([E.aum]),cls:'td-pu'},
    {lbl:'ğŸ‘¥ Peak Users',      v:Y.map(y=>y.usr).concat([E.usr]),raw:true},
    {lbl:'EBITDA Margin',      v:Y.map(y=>y.rev>0?(y.net/y.rev*100).toFixed(1)+'%':'N/A').concat([(E.net/E.rev*100).toFixed(1)+'%']),raw:true}
  ];
  document.getElementById('fc-body').innerHTML=fcRows.map(row=>{
    const cells=row.v.map((v,i)=>{
      const cl=row.clsFn?neg(v):(row.cls||'');
      const disp=row.raw?v:fmtK(v);
      const style=i===4?'background:var(--purple-pale)':'';
      return `<td class="${cl}" style="${style}">${disp}</td>`;
    }).join('');
    return `<tr><td>${row.lbl}</td>${cells}</tr>`;
  }).join('');

  renderForecastChart(Y,E);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// TAX CALCULATOR
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function recalcTax(){
  const taxES=parseFloat(document.getElementById('tax-es-corp').value)/100||0.25;
  const method=parseFloat(document.getElementById('tax-es-method').value)||0.40;
  const taxOth=parseFloat(document.getElementById('tax-other-eff').value)/100||0.09;
  const net=netIncome();
  const payES=net.map(v=>v>0?-(Math.round(v*taxES*method)):0);
  const payOth=net.map(v=>v>0?-(Math.round(v*taxOth)):0);
  const afterTax=net.map((v,i)=>v+payES[i]);

  const qShort=QQ.map(q=>q.slice(0,2)+q.slice(-2));
  const thCells=qShort.map(q=>`<th>${q}</th>`).join('');
  document.getElementById('tax-head').innerHTML=`<tr><th>Concepto ($000s)</th>${thCells}<th>Tot 26</th><th>Tot 27</th><th>Tot 28</th><th>Tot 29</th></tr>`;

  const taxRows=[
    {lbl:'Net Income (pre-tax)',v:net,     cf:(v)=>neg(v)},
    {lbl:'ğŸ‡ªğŸ‡¸ IS Pago Fracc. (EspaÃ±a)',v:payES, cf:()=>'td-neg'},
    {lbl:`ğŸŒ Tax Alt. (${document.getElementById('tax-other-name').value})`,v:payOth,cf:()=>'td-neg'},
    {lbl:'âœ… Net Income post-tax',v:afterTax,cf:(v)=>neg(v)}
  ];
  document.getElementById('tax-body').innerHTML=taxRows.map(row=>{
    const cells=row.v.map(v=>`<td class="${row.cf(v)}">${v!==0?fmtK(v):'â€”'}</td>`).join('');
    const t=[0,1,2,3].map(y=>annSum(row.v,y));
    return `<tr><td>${row.lbl}</td>${cells}${t.map(v=>`<td class="${row.cf(v)}">${v!==0?fmtK(v):'â€”'}</td>`).join('')}</tr>`;
  }).join('');

  renderTaxChart(payES,payOth);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// MASTER RECALC
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function recalcAll(){
  renderKPIRow();
  renderPLTable();
  renderCostsTable();
  renderUsersTable();
  renderKPIsPage();
  renderForecastPage();
  // Charts for active page only
  renderChartsFor(currentPage);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// CHARTS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const CC={
  pu:'rgba(123,47,190,1)',  puA:'rgba(123,47,190,.15)',
  gr:'rgba(39,174,96,1)',   grA:'rgba(39,174,96,.15)',
  re:'rgba(231,76,60,1)',   reA:'rgba(231,76,60,.15)',
  go:'rgba(243,156,18,1)',  goA:'rgba(243,156,18,.15)',
  te:'rgba(26,188,156,1)',  teA:'rgba(26,188,156,.15)'
};
const charts={};
function destroyChart(id){ if(charts[id]){charts[id].destroy();delete charts[id];} }

const baseOpts={
  responsive:true, maintainAspectRatio:false,
  plugins:{legend:{labels:{font:{family:'DM Sans',size:11},usePointStyle:true,padding:12}}},
  scales:{
    x:{grid:{color:'rgba(0,0,0,.04)'},ticks:{font:{size:10}}},
    y:{grid:{color:'rgba(0,0,0,.04)'},ticks:{font:{size:10},callback:v=>'$'+Math.round(v).toLocaleString()}}
  }
};

function qlbl(){ return QQ.map(q=>q.replace(' ','\n')); }

function renderMainChart(){
  destroyChart('main');
  const r=revenue(),o=opex(),n=netIncome();
  charts['main']=new Chart(document.getElementById('cMain'),{
    type:'bar',
    data:{labels:qlbl(),datasets:[
      {label:'Revenue $K',data:r,backgroundColor:CC.grA,borderColor:CC.gr,borderWidth:2,borderRadius:4},
      {label:'OpEx $K',data:o.map(v=>-v),backgroundColor:CC.reA,borderColor:CC.re,borderWidth:2,borderRadius:4},
      {label:'Net Income $K',data:n,type:'line',borderColor:CC.pu,backgroundColor:CC.puA,fill:true,tension:.4,pointBackgroundColor:CC.pu,pointRadius:3}
    ]},
    options:{...baseOpts,interaction:{mode:'index'}}
  });
}

function renderAuMChart(){
  destroyChart('aum');
  charts['aum']=new Chart(document.getElementById('cAum'),{
    type:'line',
    data:{labels:qlbl(),datasets:[{label:'AuM/TVL $K',data:aum(),borderColor:CC.pu,backgroundColor:CC.puA,fill:true,tension:.4,pointBackgroundColor:CC.pu,pointRadius:3}]},
    options:{...baseOpts}
  });
}

function renderCostsChart(){
  destroyChart('costs');
  const labels=Object.keys(BASE_COSTS);
  const vals=labels.map(k=>annSum(BASE_COSTS[k],0));
  charts['costs']=new Chart(document.getElementById('cCosts'),{
    type:'doughnut',
    data:{labels,datasets:[{data:vals,backgroundColor:[CC.pu,CC.gr,CC.re,CC.go,CC.te,'rgba(52,152,219,.8)'],borderWidth:2,borderColor:'#fff'}]},
    options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'right',labels:{font:{size:10},padding:8}}}}
  });
}

function renderCashChart(){
  destroyChart('cash');
  const c=cashBalance();
  charts['cash']=new Chart(document.getElementById('cCash'),{
    type:'line',
    data:{labels:qlbl(),datasets:[{label:'Cash Balance $K',data:c,borderColor:CC.te,backgroundColor:CC.teA,fill:true,tension:.4,pointBackgroundColor:c.map(v=>v>=0?CC.te:CC.re),pointRadius:4}]},
    options:{...baseOpts}
  });
}

function renderUsersChart(){
  destroyChart('users');
  const u=users();
  charts['users']=new Chart(document.getElementById('cUsers'),{
    type:'bar',
    data:{labels:qlbl(),datasets:[{label:'Usuarios',data:u,backgroundColor:CC.puA,borderColor:CC.pu,borderWidth:2,borderRadius:6}]},
    options:{...baseOpts,scales:{...baseOpts.scales,y:{...baseOpts.scales.y,ticks:{callback:v=>v.toLocaleString()}}}}
  });
}

function renderAuMUserChart(){
  destroyChart('aumUser');
  const u=users(),a=aum();
  const apu=u.map((v,i)=>v>0?Math.round(a[i]/v):0);
  charts['aumUser']=new Chart(document.getElementById('cAumUser'),{
    type:'line',
    data:{labels:qlbl(),datasets:[{label:'AuM/Usuario $K',data:apu,borderColor:CC.go,backgroundColor:CC.goA,fill:true,tension:.4,pointBackgroundColor:CC.go,pointRadius:4}]},
    options:{...baseOpts}
  });
}

function renderEbitdaChart(){
  destroyChart('ebitda');
  const r=revenue(),n=netIncome();
  const yrLabels=['2026','2027','2028','2029'];
  const margins=yrLabels.map((_,i)=>{const yr=annSum(r,i);return yr>0?parseFloat((annSum(n,i)/yr*100).toFixed(1)):0;});
  charts['ebitda']=new Chart(document.getElementById('cEbitda'),{
    type:'bar',
    data:{labels:yrLabels,datasets:[{label:'EBITDA Margin %',data:margins,backgroundColor:margins.map(v=>v>=0?CC.grA:CC.reA),borderColor:margins.map(v=>v>=0?CC.gr:CC.re),borderWidth:2,borderRadius:8}]},
    options:{...baseOpts,scales:{...baseOpts.scales,y:{...baseOpts.scales.y,ticks:{callback:v=>v+'%'}}}}
  });
}

function renderGrowthChart(){
  destroyChart('growth');
  const r=revenue();
  const yrLabels=['2026','2027','2028','2029'];
  const revY=yrLabels.map((_,i)=>annSum(r,i));
  const gr=revY.map((v,i)=>i>0?parseFloat(((v-revY[i-1])/Math.abs(revY[i-1])*100).toFixed(1)):0);
  charts['growth']=new Chart(document.getElementById('cGrowth'),{
    type:'line',
    data:{labels:yrLabels,datasets:[{label:'Revenue YoY %',data:gr,borderColor:CC.pu,backgroundColor:CC.puA,fill:true,tension:.4,pointBackgroundColor:CC.pu,pointRadius:6}]},
    options:{...baseOpts,scales:{...baseOpts.scales,y:{...baseOpts.scales.y,ticks:{callback:v=>v+'%'}}}}
  });
}

function renderTaxChart(payES,payOth){
  destroyChart('tax');
  const yrLabels=['2026','2027','2028','2029'];
  const es=yrLabels.map((_,i)=>Math.abs(annSum(payES,i)));
  const ot=yrLabels.map((_,i)=>Math.abs(annSum(payOth,i)));
  charts['tax']=new Chart(document.getElementById('cTax'),{
    type:'bar',
    data:{labels:yrLabels,datasets:[
      {label:'ğŸ‡ªğŸ‡¸ IS EspaÃ±a $K',data:es,backgroundColor:CC.puA,borderColor:CC.pu,borderWidth:2,borderRadius:6},
      {label:'ğŸŒ Tax Alternativo $K',data:ot,backgroundColor:CC.goA,borderColor:CC.go,borderWidth:2,borderRadius:6}
    ]},
    options:{...baseOpts}
  });
}

function renderForecastChart(Y,E){
  destroyChart('forecast');
  if(!Y||!E) return;
  const labels=['2026','2027','2028','2029','2030E'];
  const revY=Y.map(y=>y.rev).concat([E.rev]);
  const netY=Y.map(y=>y.net).concat([E.net]);
  const cashY=Y.map(y=>y.cash).concat([E.cash]);
  charts['forecast']=new Chart(document.getElementById('cForecast'),{
    type:'bar',
    data:{labels,datasets:[
      {label:'Revenue $K',data:revY,backgroundColor:CC.grA,borderColor:CC.gr,borderWidth:2,borderRadius:6},
      {label:'Net Income $K',data:netY,backgroundColor:netY.map(v=>v>=0?CC.puA:CC.reA),borderColor:netY.map(v=>v>=0?CC.pu:CC.re),borderWidth:2,borderRadius:6},
      {label:'Cash Balance $K',data:cashY,type:'line',borderColor:CC.te,backgroundColor:'transparent',tension:.4,pointBackgroundColor:cashY.map(v=>v>=0?CC.te:CC.re),pointRadius:6}
    ]},
    options:{...baseOpts,interaction:{mode:'index'}}
  });
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// EXPORT
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function exportCSV(){
  const r=revenue(),o=opex(),n=netIncome(),c=cashBalance(),a=aum(),u=users();
  let csv='Stabolut Financial Model â€” $10M Round\n\n';
  csv+='Metric,$K,'+QQ.join(',')+ '\n';
  csv+=`Users,,${u.join(',')}\n`;
  csv+=`AuM/TVL,,${a.join(',')}\n`;
  csv+=`APR (%),,%,${APR.map(v=>(v*100).toFixed(0)+'%').join(',')}\n`;
  csv+=`Protocol Revenue,,${r.join(',')}\n`;
  csv+=`Total OpEx,,${o.join(',')}\n`;
  csv+=`Net Income,,${n.join(',')}\n`;
  csv+=`Capital Raise,,${CAP_RAISE.join(',')}\n`;
  csv+=`M&A,,${MA.join(',')}\n`;
  csv+=`Cash Balance,,${c.join(',')}\n`;
  for(const[k,v] of Object.entries(BASE_COSTS)) csv+=`${k},,${v.join(',')}\n`;
  const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
  const a2=document.createElement('a'); a2.href=URL.createObjectURL(blob);
  a2.download='Stabolut_Financial_Model.csv'; a2.click();
}

function exportExcel(){
  if(typeof XLSX==='undefined'){alert('Error: librerÃ­a Excel no cargada. Comprueba la conexiÃ³n a internet.');return;}
  const r=revenue(),o=opex(),n=netIncome(),c=cashBalance(),a=aum(),u=users();
  const wb=XLSX.utils.book_new();

  // Sheet 1: Overview
  const s1=[
    ['STABOLUT â€” FINANCIAL MODEL Â· $10M Round Scenario','','','',''],
    ['Generado: '+new Date().toLocaleDateString('es-ES')],
    [],
    ['Metric ($000s)',...QQ],
    ['Users',...u],
    ['AuM/TVL',...a],
    ['APR (%)',...APR.map(v=>(v*100).toFixed(0)+'%')],
    ['Protocol Revenue',...r],
    ['Total OpEx',...o],
    ['Net Income',...n],
    ['Capital Raise',...CAP_RAISE],
    ['M&A',...MA],
    ['Cash Balance',...c]
  ];
  XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet(s1),'P&L Trimestral');

  // Sheet 2: Costs
  const s2=[['Cost Item ($000s)',...QQ,'Total 26','Total 27','Total 28','Total 29']];
  for(const[k,v] of Object.entries(BASE_COSTS))
    s2.push([k,...v,...[0,1,2,3].map(y=>annSum(v,y))]);
  s2.push(['Manual Adjustments',...costAdj,...[0,1,2,3].map(y=>annSum(costAdj,y))]);
  s2.push(['TOTAL OpEx',...o,...[0,1,2,3].map(y=>annSum(o,y))]);
  XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet(s2),'Costes');

  // Sheet 3: Annual Summary
  const Y=[0,1,2,3].map(i=>({rev:annSum(r,i),opex:annSum(o,i),net:annSum(n,i),cash:c[i*4+3]}));
  const rev30=Math.round(Y[3].rev*1.30); const opex30=Math.round(Y[3].opex*1.05);
  const s3=[
    ['Annual Summary ($000s)','2026','2027','2028','2029','2030E (Proj)'],
    ['Revenue',...Y.map(y=>y.rev),rev30],
    ['OpEx',...Y.map(y=>y.opex),opex30],
    ['Net Income',...Y.map(y=>y.net),rev30-opex30],
    ['Cash Balance (YE)',...Y.map(y=>y.cash),c[15]+rev30-opex30+MA[15]]
  ];
  XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet(s3),'Resumen Anual');

  // Sheet 4: Users
  XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet([
    ['Quarter',...QQ],
    ['Users',...u],
    ['User Delta',...userDelta],
    ['AuM/TVL',...a]
  ]),'Usuarios');

  XLSX.writeFile(wb,'Stabolut_Financial_Model.xlsx');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// INIT
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.addEventListener('DOMContentLoaded',()=>{
  const today=new Date().toLocaleDateString('es-ES',{day:'2-digit',month:'long',year:'numeric'});
  document.getElementById('today-date').textContent='Actualizado: '+today;
  document.getElementById('footer-date').textContent=today;

  buildUserInputs();
  buildCostInputs();

  // Initial render of all data
  renderKPIRow();
  renderPLTable();
  renderCostsTable();
  renderUsersTable();
  renderKPIsPage();
  renderForecastPage();

  // Charts only for the visible (dashboard) page
  // Use requestAnimationFrame so canvas is fully laid out first
  requestAnimationFrame(()=>{
    renderMainChart();
    renderAuMChart();
    renderCostsChart();
    renderCashChart();
  });
});
</script>
</body>
</html>
