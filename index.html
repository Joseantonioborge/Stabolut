<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Stabolut â€” Financial Dashboard</title>
<!-- Chart.js: NO integrity attr so it never gets blocked by SRI mismatch -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<!-- SheetJS for Excel export -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:opsz,wght@9..40,400;9..40,500;9..40,600;9..40,700&family=Space+Mono&display=swap" rel="stylesheet">
<style>
/* â”€â”€ VARIABLES â”€â”€ */
:root{
  --pu:#7B2FBE; --pul:#9B59D0; --pup:#F3EAFB; --pum:#E0C8F5;
  --gr:#27AE60; --grp:#E8F8EF;
  --re:#E74C3C; --rep:#FDECEA;
  --go:#F39C12; --gop:#FEF9E7;
  --te:#1ABC9C;
  --g1:#F8F9FA; --g2:#EEF0F3; --g3:#DEE2E9;
  --g5:#8892A0; --g7:#4A5568; --g9:#1A202C;
  --bg:#F5F6FB; --wh:#FFFFFF;
  --sh:0 2px 12px rgba(123,47,190,.08);
  --shh:0 6px 28px rgba(123,47,190,.16);
  --r:16px; --rs:10px;
  --f:'DM Sans',system-ui,sans-serif;
  --fm:'Space Mono',monospace;
}
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%}
body{font-family:var(--f);background:var(--bg);color:var(--g9);min-height:100vh}

/* â”€â”€ LAYOUT â”€â”€ */
.layout{display:flex;min-height:100vh}

/* â”€â”€ SIDEBAR â”€â”€ */
.sidebar{
  width:228px;min-width:228px;background:var(--wh);
  border-right:1.5px solid var(--g2);
  display:flex;flex-direction:column;
  position:sticky;top:0;height:100vh;overflow-y:auto;z-index:100;
  transition:transform .25s
}
.sb-logo{padding:22px 20px 14px;border-bottom:1px solid var(--g2)}
.sb-wm{font-size:26px;font-weight:900;letter-spacing:-1px;color:var(--pu);line-height:1}
.sb-wm b{color:var(--pul)}
.sb-badge{display:inline-block;margin-top:7px;font-size:10px;font-weight:700;
  letter-spacing:1px;text-transform:uppercase;color:var(--pu);
  background:var(--pup);padding:3px 8px;border-radius:20px}
.sb-nav{padding:10px 8px;flex:1}
.nav-sep{font-size:10px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;
  color:var(--g5);padding:14px 10px 4px}
.nb{display:flex;align-items:center;gap:10px;width:100%;padding:9px 10px;
  border-radius:var(--rs);cursor:pointer;font-size:13.5px;font-weight:500;
  color:var(--g7);transition:all .15s;border:none;background:none;text-align:left;
  font-family:var(--f)}
.nb:hover{background:var(--pup);color:var(--pu)}
.nb.active{background:var(--pu);color:#fff}
.ic{width:20px;text-align:center;font-size:14px}

/* â”€â”€ MAIN â”€â”€ */
.main{flex:1;min-width:0;display:flex;flex-direction:column}

/* â”€â”€ TOPBAR â”€â”€ */
.topbar{
  background:var(--wh);border-bottom:1.5px solid var(--g2);
  padding:13px 26px;display:flex;align-items:center;
  justify-content:space-between;position:sticky;top:0;z-index:50;gap:12px
}
.tl{display:flex;align-items:center;gap:12px}
.topbar h1{font-size:17px;font-weight:700;color:var(--g9)}
.tsub{font-size:11.5px;color:var(--g5);margin-top:2px}
.tr{display:flex;gap:8px;align-items:center;flex-wrap:wrap}

/* â”€â”€ BUTTONS â”€â”€ */
.btn{display:inline-flex;align-items:center;gap:5px;padding:7px 14px;
  border-radius:var(--rs);font-size:12.5px;font-weight:600;cursor:pointer;
  border:none;transition:all .15s;font-family:var(--f)}
.bp{background:var(--pu);color:#fff}
.bp:hover{background:var(--pul);box-shadow:0 4px 14px rgba(123,47,190,.3)}
.bo{background:var(--wh);color:var(--pu);border:1.5px solid var(--pu)}
.bo:hover{background:var(--pup)}
.bg{background:var(--g1);color:var(--g7)}
.bg:hover{background:var(--g2)}
.hbg{display:none;background:none;border:none;cursor:pointer;font-size:22px;color:var(--g7);padding:4px}

/* â”€â”€ PAGES â”€â”€ */
.page{display:none;padding:22px 26px 40px}
.page.active{display:block;animation:fi .2s ease}
@keyframes fi{from{opacity:0;transform:translateY(5px)}to{opacity:1;transform:translateY(0)}}

/* â”€â”€ KPI GRID â”€â”€ */
.kg{display:grid;grid-template-columns:repeat(auto-fit,minmax(182px,1fr));gap:13px;margin-bottom:20px}
.kc{background:var(--wh);border-radius:var(--r);padding:17px 19px;
  border:1px solid var(--g2);box-shadow:var(--sh);
  position:relative;overflow:hidden;transition:all .2s}
.kc:hover{box-shadow:var(--shh);transform:translateY(-2px)}
.kc::before{content:'';position:absolute;top:0;left:0;right:0;height:4px;border-radius:var(--r) var(--r) 0 0}
.kc.cp::before{background:linear-gradient(90deg,var(--pu),var(--pul))}
.kc.cg::before{background:linear-gradient(90deg,#27AE60,#2ECC71)}
.kc.cr::before{background:linear-gradient(90deg,#E74C3C,#F1948A)}
.kc.co::before{background:linear-gradient(90deg,#F39C12,#F7DC6F)}
.kc.ct::before{background:linear-gradient(90deg,#1ABC9C,#48C9B0)}
.kl{font-size:11px;font-weight:700;color:var(--g5);text-transform:uppercase;letter-spacing:.5px}
.kv{font-size:22px;font-weight:700;color:var(--g9);margin:5px 0 3px;font-family:var(--fm)}
.kd{font-size:11.5px;font-weight:600}
.kd.pos{color:var(--gr)} .kd.neg{color:var(--re)}
.ki{position:absolute;right:14px;top:14px;font-size:24px;opacity:.12}

/* â”€â”€ CHARTS GRID â”€â”€ */
.cg2{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:16px;margin-bottom:18px}
.cg2 .wide{grid-column:1/-1}
.cc{background:var(--wh);border-radius:var(--r);padding:20px;border:1px solid var(--g2);box-shadow:var(--sh)}
.ch{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:14px}
.ct{font-size:13.5px;font-weight:700;color:var(--g9)}
.csub{font-size:11px;color:var(--g5);margin-top:2px}
/* CRITICAL: chart container must have explicit height and position:relative */
.cw{position:relative;width:100%;height:240px}
.cw canvas{position:absolute;top:0;left:0}

/* â”€â”€ SECTION TITLE â”€â”€ */
.st{font-size:15px;font-weight:700;color:var(--g9);
  margin:22px 0 13px;display:flex;align-items:center;gap:10px}
.st::after{content:'';flex:1;height:2px;background:var(--g2)}

/* â”€â”€ CARD â”€â”€ */
.card{background:var(--wh);border-radius:var(--r);padding:20px;border:1px solid var(--g2);box-shadow:var(--sh)}
.card-t{font-size:11.5px;font-weight:700;letter-spacing:.5px;text-transform:uppercase;color:var(--g5);margin-bottom:11px}
.card.dash{border:2px dashed var(--pul);background:var(--pup)}

/* â”€â”€ TABLE â”€â”€ */
.tw{overflow-x:auto;border-radius:var(--rs)}
table{width:100%;border-collapse:collapse;font-size:12px}
thead th{background:var(--pup);color:var(--pu);font-weight:700;font-size:10px;
  text-transform:uppercase;letter-spacing:.4px;padding:8px 11px;
  text-align:right;white-space:nowrap}
thead th:first-child{text-align:left}
tbody tr{border-bottom:1px solid var(--g2);transition:background .1s}
tbody tr:hover{background:var(--g1)}
tbody td{padding:8px 11px;text-align:right;color:var(--g7);white-space:nowrap}
tbody td:first-child{text-align:left;font-weight:600;color:var(--g9)}
.p{color:var(--gr)!important;font-weight:700} .n{color:var(--re)!important;font-weight:700}
.pu{color:var(--pu)!important;font-weight:700}
tr.rt{background:var(--g1)} tr.rt td{font-weight:700;border-top:2px solid var(--pum)}

/* â”€â”€ INPUTS â”€â”€ */
.ig{display:grid;grid-template-columns:repeat(auto-fill,minmax(190px,1fr));gap:11px}
.igrp{display:flex;flex-direction:column;gap:4px}
.ilbl{font-size:10.5px;font-weight:700;text-transform:uppercase;letter-spacing:.4px;color:var(--g7)}
.iw{position:relative}
.ipfx{position:absolute;left:9px;top:50%;transform:translateY(-50%);
  font-size:12.5px;font-weight:600;color:var(--g5);pointer-events:none}
.if{width:100%;padding:8px 11px;border:1.5px solid var(--g3);border-radius:var(--rs);
  font-family:var(--f);font-size:12.5px;color:var(--g9);background:var(--wh);
  outline:none;transition:border-color .15s,box-shadow .15s}
.if.pfx{padding-left:24px}
.if:focus{border-color:var(--pu);box-shadow:0 0 0 3px rgba(123,47,190,.1)}
select.if{cursor:pointer}

.alert{background:var(--pup);border-left:4px solid var(--pu);border-radius:var(--rs);
  padding:10px 13px;font-size:12.5px;color:var(--pu);margin-bottom:16px;font-weight:500;line-height:1.5}
.rnote{background:var(--g1);border:1px solid var(--g2);border-radius:var(--rs);
  padding:8px 11px;font-size:11.5px;color:var(--g7);margin-top:11px;
  display:flex;align-items:center;gap:5px}
.acts{display:flex;gap:9px;flex-wrap:wrap;margin-top:14px}

/* â”€â”€ FOOTER â”€â”€ */
.footer{background:var(--wh);border-top:1px solid var(--g2);padding:11px 26px;
  font-size:11px;color:var(--g5);display:flex;justify-content:space-between;
  align-items:center;flex-wrap:wrap;gap:5px}

/* â”€â”€ RESPONSIVE â”€â”€ */
@media(max-width:900px){
  .sidebar{position:fixed;transform:translateX(-100%);box-shadow:none}
  .sidebar.open{transform:translateX(0);box-shadow:0 0 40px rgba(0,0,0,.2)}
  .hbg{display:block}
  .page{padding:14px 12px 30px}
  .topbar{padding:11px 14px}
  .cg2{grid-template-columns:1fr}
}
@media(max-width:560px){
  .kg{grid-template-columns:repeat(2,1fr)}
  .ig{grid-template-columns:repeat(2,1fr)}
  .kv{font-size:18px}
}
</style>
</head>
<body>
<div class="layout">

<!-- â•â•â•â•â•â• SIDEBAR â•â•â•â•â•â• -->
<nav class="sidebar" id="sidebar">
  <div class="sb-logo">
    <div class="sb-wm">sta<b>bo</b>lut</div>
    <div class="sb-badge">$10M Round Â· 2026â€“2029</div>
  </div>
  <div class="sb-nav">
    <div class="nav-sep">Principal</div>
    <button class="nb active" data-page="dashboard"><span class="ic">ğŸ“Š</span>Dashboard</button>
    <button class="nb" data-page="users"><span class="ic">ğŸ‘¥</span>Usuarios / Clientes</button>
    <button class="nb" data-page="costs"><span class="ic">ğŸ’°</span>Costes Operativos</button>
    <button class="nb" data-page="taxes"><span class="ic">ğŸ›ï¸</span>Impuestos</button>
    <div class="nav-sep">AnÃ¡lisis</div>
    <button class="nb" data-page="kpis"><span class="ic">ğŸ¯</span>KPIs EstratÃ©gicos</button>
    <button class="nb" data-page="forecast"><span class="ic">ğŸ“ˆ</span>Forecast 5 AÃ±os</button>
    <div class="nav-sep">Exportar</div>
    <button class="nb" onclick="doExportExcel()"><span class="ic">ğŸ“¥</span>Excel (.xlsx)</button>
    <button class="nb" onclick="doExportCSV()"><span class="ic">ğŸ“„</span>CSV</button>
    <button class="nb" onclick="window.print()"><span class="ic">ğŸ–¨ï¸</span>PDF / Imprimir</button>
  </div>
</nav>

<!-- â•â•â•â•â•â• MAIN â•â•â•â•â•â• -->
<div class="main">
  <div class="topbar">
    <div class="tl">
      <button class="hbg" onclick="document.getElementById('sidebar').classList.toggle('open')">â˜°</button>
      <div>
        <h1 id="page-title">ğŸ“Š Overview Dashboard</h1>
        <div class="tsub">Escenario $10M Round Â· <span id="hdate"></span></div>
      </div>
    </div>
    <div class="tr">
      <button class="btn bo" onclick="recalcAll()">ğŸ”„ Recalcular</button>
      <button class="btn bp" onclick="doExportExcel()">â¬‡ Excel</button>
      <button class="btn bg" onclick="doExportCSV()">â¬‡ CSV</button>
    </div>
  </div>

  <!-- â•â•â•â• PAGE: DASHBOARD â•â•â•â• -->
  <div id="page-dashboard" class="page active">
    <div class="kg" id="kpi-dash"></div>
    <div class="cg2">
      <div class="cc wide">
        <div class="ch"><div>
          <div class="ct">ğŸ“ˆ Revenue vs OpEx vs Net Income â€” Trimestral</div>
          <div class="csub">$000s Â· Q1 2026 â€“ Q4 2029</div>
        </div></div>
        <div class="cw" style="height:260px"><canvas id="cMain"></canvas></div>
      </div>
    </div>
    <div class="cg2">
      <div class="cc">
        <div class="ch"><div><div class="ct">ğŸ’ AuM / TVL Growth</div><div class="csub">$000s trimestral</div></div></div>
        <div class="cw"><canvas id="cAum"></canvas></div>
      </div>
      <div class="cc">
        <div class="ch"><div><div class="ct">ğŸ’° Desglose Costes 2026</div><div class="csub">DistribuciÃ³n anual</div></div></div>
        <div class="cw"><canvas id="cCosts"></canvas></div>
      </div>
      <div class="cc">
        <div class="ch"><div><div class="ct">ğŸ’µ Cash Balance Evolution</div><div class="csub">$000s acumulado</div></div></div>
        <div class="cw"><canvas id="cCash"></canvas></div>
      </div>
    </div>
    <div class="st">ğŸ“‹ P&amp;L Trimestral Completo</div>
    <div class="card" style="padding:0"><div class="tw"><table><thead id="pl-h"></thead><tbody id="pl-b"></tbody></table></div></div>
  </div>

  <!-- â•â•â•â• PAGE: USERS â•â•â•â• -->
  <div id="page-users" class="page">
    <div class="alert">âœï¸ <strong>Modo ediciÃ³n:</strong> Modifica usuarios por trimestre. Los cambios recalculan todo el modelo (AuM proporcional, Revenue, Net Income, Cash Balance).</div>
    <div class="card dash" style="margin-bottom:18px">
      <div class="card-t">ğŸ‘¥ Usuarios por Trimestre â€” Entrada Manual</div>
      <div class="ig" id="user-inp"></div>
      <div class="rnote">ğŸ”„ Cada cambio actualiza el modelo completo. El AuM se recalcula proporcionalmente a los usuarios introducidos.</div>
      <div class="acts">
        <button class="btn bp" onclick="recalcAll()">ğŸ”„ Recalcular Todo</button>
        <button class="btn bg" onclick="resetUsers()">â†© Restaurar Originales</button>
      </div>
    </div>
    <div class="cg2">
      <div class="cc">
        <div class="ct" style="margin-bottom:13px">ğŸ‘¤ Usuarios por Trimestre</div>
        <div class="cw"><canvas id="cUsers"></canvas></div>
      </div>
      <div class="cc">
        <div class="ct" style="margin-bottom:13px">ğŸ’ AuM por Usuario ($K medio)</div>
        <div class="cw"><canvas id="cAumU"></canvas></div>
      </div>
    </div>
    <div class="st">ğŸ“Š Tabla Usuarios &amp; AuM</div>
    <div class="card" style="padding:0"><div class="tw"><table><thead id="usr-h"></thead><tbody id="usr-b"></tbody></table></div></div>
  </div>

  <!-- â•â•â•â• PAGE: COSTS â•â•â•â• -->
  <div id="page-costs" class="page">
    <div class="alert">âœï¸ <strong>Ajuste de Gastos:</strong> Introduce ajustes adicionales (+) o ahorros (-) sobre el OpEx base. Valores en $000s.</div>
    <div class="card dash" style="margin-bottom:18px">
      <div class="card-t">ğŸ’¸ Ajuste Manual de Gastos por Trimestre ($000s)</div>
      <div class="ig" id="cost-inp"></div>
      <div class="rnote">â„¹ï¸ Positivo = gasto extra. Negativo = ahorro. Se suma al OpEx base y recalcula Net Income y Cash.</div>
      <div class="acts">
        <button class="btn bp" onclick="recalcAll()">ğŸ”„ Recalcular Todo</button>
        <button class="btn bg" onclick="resetCosts()">â†© Limpiar Ajustes</button>
      </div>
    </div>
    <div class="st">ğŸ“Š Estructura de Costes Completa</div>
    <div class="card" style="padding:0"><div class="tw"><table><thead id="cost-h"></thead><tbody id="cost-b"></tbody></table></div></div>
  </div>

  <!-- â•â•â•â• PAGE: TAXES â•â•â•â• -->
  <div id="page-taxes" class="page">
    <div class="alert">ğŸ›ï¸ <strong>Calculadora Fiscal:</strong> Configura tipos impositivos por jurisdicciÃ³n. Solo aplica en trimestres con Net Income positivo.</div>
    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(270px,1fr));gap:16px;margin-bottom:18px">
      <div class="card">
        <div class="card-t">ğŸ‡ªğŸ‡¸ EspaÃ±a â€” ParÃ¡metros Fiscales</div>
        <div class="igrp" style="margin-bottom:9px"><label class="ilbl">Impuesto Sociedades (%)</label>
          <div class="iw"><span class="ipfx">%</span><input class="if pfx" id="tx-es-c" type="number" value="25" min="0" max="100" step=".5" oninput="recalcTax()"></div></div>
        <div class="igrp" style="margin-bottom:9px"><label class="ilbl">IVA (%)</label>
          <div class="iw"><span class="ipfx">%</span><input class="if pfx" id="tx-es-v" type="number" value="21" min="0" max="30" step=".5" oninput="recalcTax()"></div></div>
        <div class="igrp" style="margin-bottom:9px"><label class="ilbl">RetenciÃ³n Dividendos (%)</label>
          <div class="iw"><span class="ipfx">%</span><input class="if pfx" id="tx-es-d" type="number" value="19" min="0" max="30" step=".5" oninput="recalcTax()"></div></div>
        <div class="igrp"><label class="ilbl">MÃ©todo Pagos Fraccionados</label>
          <select class="if" id="tx-es-m" onchange="recalcTax()">
            <option value="0.18">MÃ©todo 1 â€” 18% cuota aÃ±o anterior</option>
            <option value="0.40" selected>MÃ©todo 2 â€” 40% resultado fiscal</option>
          </select></div>
      </div>
      <div class="card">
        <div class="card-t">ğŸŒ JurisdicciÃ³n Alternativa</div>
        <div class="igrp" style="margin-bottom:9px"><label class="ilbl">PaÃ­s / JurisdicciÃ³n</label>
          <input class="if" id="tx-ot-n" type="text" value="UAE / Cayman Islands" oninput="recalcTax()"></div>
        <div class="igrp" style="margin-bottom:9px"><label class="ilbl">Corporate Tax (%)</label>
          <div class="iw"><span class="ipfx">%</span><input class="if pfx" id="tx-ot-c" type="number" value="9" min="0" max="100" step=".5" oninput="recalcTax()"></div></div>
        <div class="igrp" style="margin-bottom:9px"><label class="ilbl">Withholding Tax (%)</label>
          <div class="iw"><span class="ipfx">%</span><input class="if pfx" id="tx-ot-w" type="number" value="0" min="0" max="50" step=".5" oninput="recalcTax()"></div></div>
        <div class="igrp"><label class="ilbl">Tipo Efectivo Estimado (%)</label>
          <div class="iw"><span class="ipfx">%</span><input class="if pfx" id="tx-ot-e" type="number" value="9" min="0" max="100" step=".5" oninput="recalcTax()"></div></div>
      </div>
      <div class="card">
        <div class="card-t">âš ï¸ Notas Fiscales</div>
        <div style="font-size:12px;color:var(--g7);line-height:1.8">
          <p>ğŸ‡ªğŸ‡¸ <b>EspaÃ±a:</b> Pagos fracc. en abril (P1), octubre (P3) y diciembre (P11). LiquidaciÃ³n mod. 200 en julio siguiente.</p><br>
          <p>ğŸ“‹ <b>PÃ©rdidas 2026:</b> Sin IS. BINs compensables con beneficios futuros (art. 26 LIS, lÃ­mite 70%).</p><br>
          <p>ğŸŒ <b>Internacional:</b> Aplicar convenios de doble imposiciÃ³n. Evaluar rÃ©gimen ETVE para dividendos de subsidiarias.</p><br>
          <p>ğŸ’¡ <b>Crypto/Stablecoin:</b> TributaciÃ³n segÃºn estructura societaria (capital mobiliario o actividad econÃ³mica).</p>
        </div>
      </div>
    </div>
    <div class="st">ğŸ“Š Pagos Trimestrales Estimados</div>
    <div class="card" style="padding:0;margin-bottom:18px"><div class="tw"><table><thead id="tax-h"></thead><tbody id="tax-b"></tbody></table></div></div>
    <div class="cg2">
      <div class="cc">
        <div class="ct" style="margin-bottom:13px">ğŸ›ï¸ Carga Fiscal Estimada por AÃ±o ($000s)</div>
        <div class="cw"><canvas id="cTax"></canvas></div>
      </div>
    </div>
  </div>

  <!-- â•â•â•â• PAGE: KPIs â•â•â•â• -->
  <div id="page-kpis" class="page">
    <div class="kg" id="kpi-strat"></div>
    <div class="st">ğŸ“Š KPIs por AÃ±o</div>
    <div class="card" style="padding:0;margin-bottom:18px"><div class="tw"><table><thead id="kpi-h"></thead><tbody id="kpi-b"></tbody></table></div></div>
    <div class="cg2">
      <div class="cc">
        <div class="ct" style="margin-bottom:13px">ğŸ“Š EBITDA Margin por AÃ±o (%)</div>
        <div class="cw"><canvas id="cEbitda"></canvas></div>
      </div>
      <div class="cc">
        <div class="ct" style="margin-bottom:13px">ğŸ¯ Revenue Growth Rate (YoY %)</div>
        <div class="cw"><canvas id="cGrowth"></canvas></div>
      </div>
    </div>
  </div>

  <!-- â•â•â•â• PAGE: FORECAST â•â•â•â• -->
  <div id="page-forecast" class="page">
    <div class="alert">ğŸ“… Forecast 5 aÃ±os (2026â€“2030). Datos reales hasta Q4 2029 + proyecciÃ³n 2030 con +30% Revenue.</div>
    <div class="kg" id="kpi-fc"></div>
    <div class="st">ğŸ“ˆ ProyecciÃ³n 5 AÃ±os</div>
    <div class="cc" style="margin-bottom:18px">
      <div class="cw" style="height:300px"><canvas id="cFc"></canvas></div>
    </div>
    <div class="st">ğŸ“‹ Tabla Anual Completa 2026â€“2030</div>
    <div class="card" style="padding:0"><div class="tw"><table><thead id="fc-h"></thead><tbody id="fc-b"></tbody></table></div></div>
  </div>

  <div class="footer">
    <span>Â© 2026 Stabolut Financial Model v3.2 Â· Confidencial</span>
    <span>$000s Â· Escenario $10M Round Â· <span id="fdate"></span></span>
  </div>
</div><!-- /main -->
</div><!-- /layout -->

<script>
'use strict';

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DATA
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const QQ=['Q1 2026','Q2 2026','Q3 2026','Q4 2026',
          'Q1 2027','Q2 2027','Q3 2027','Q4 2027',
          'Q1 2028','Q2 2028','Q3 2028','Q4 2028',
          'Q1 2029','Q2 2029','Q3 2029','Q4 2029'];

const BU=[20,100,200,200,600,840,1176,1529,1987,2385,2862,3434,3778,4155,4571,5028];
const BA=[20000,100000,200000,200000,600000,840000,1176000,1528800,1987440,2384928,2861914,3434296,3777726,4155499,4571048,5028153];
const APR=[.30,.30,.29,.29,.28,.27,.26,.25,.24,.23,.21,.20,.19,.18,.16,.16];
const CAP=[5000,5000,0,0,0,0,0,0,0,0,0,0,0,0,0,0];
const MA=[-1000,-2000,-1000,-1000,-2000,-4000,-4000,-4000,-4000,-4000,-4000,-4000,-4000,-4000,-4000,-4000];
const BC={
  'Engineering & Dev':   [300,400,500,500,500,500,500,500,600,600,600,600,600,600,600,600],
  'BD & Partnerships':   [140,150,150,150,150,150,150,150,150,150,150,150,150,150,150,150],
  'Marketing & Growth':  [2000,1500,2000,2500,2500,2500,2500,2500,2000,2000,1500,1500,1500,1500,1500,1500],
  'Compliance & Legal':  [500,500,400,400,400,400,250,250,250,250,250,250,250,250,250,250],
  'Ops & Infra':         [120,140,150,170,190,200,200,200,200,200,200,200,200,200,200,200],
  'G&A':                 [30,40,50,60,70,70,70,70,70,70,70,70,70,70,70,70]
};

// mutable state
let uDelta=Array(16).fill(0);
let cAdj  =Array(16).fill(0);

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   COMPUTED
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const users   =()=>BU.map((v,i)=>Math.max(0,v+uDelta[i]));
const aum     =()=>users().map((v,i)=>BU[i]>0?Math.round(BA[i]*(v/BU[i])):0);
const revenue =()=>aum().map((a,i)=>Math.round(a*APR[i]*0.20/4));
const opex    =()=>QQ.map((_,i)=>Object.values(BC).reduce((s,a)=>s+a[i],0)+cAdj[i]);
const netInc  =()=>{ const r=revenue(),o=opex(); return r.map((v,i)=>v-o[i]); };
const cashBal =()=>{
  const n=netInc(); let p=0; return n.map((v,i)=>{ p+=v+CAP[i]+MA[i]; return Math.round(p); });
};
const aSum=(a,y)=>a.slice(y*4,y*4+4).reduce((s,v)=>s+v,0);

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FORMAT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function fmt(v){
  if(v==null) return 'â€”';
  const s=v<0,a=Math.abs(v);
  const str=a>=1e6?(a/1e6).toFixed(1)+'M':a>=1000?(a/1000).toFixed(0)+'K':a.toFixed(0);
  return (s?'-':'')+'$'+str;
}
function fmtK(v){
  if(v==null) return 'â€”';
  const n=v<0,a=Math.abs(Math.round(v));
  return (n?'(':'')+'$'+a.toLocaleString('es-ES')+(n?')':'');
}
function nc(v){ return v>0?'p':v<0?'n':''; }  // css class suffix

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   NAVIGATION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const TITLES={
  dashboard:'ğŸ“Š Overview Dashboard', users:'ğŸ‘¥ Usuarios / Clientes',
  costs:'ğŸ’° Costes Operativos',       taxes:'ğŸ›ï¸ Calculadora Fiscal',
  kpis:'ğŸ¯ KPIs EstratÃ©gicos',        forecast:'ğŸ“ˆ Forecast 5 AÃ±os'
};
let curPage='dashboard';

document.querySelectorAll('.nb[data-page]').forEach(b=>{
  b.addEventListener('click',()=>goTo(b.dataset.page));
});

function goTo(id){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.nb').forEach(b=>b.classList.remove('active'));
  const pg=document.getElementById('page-'+id);
  if(!pg) return;
  pg.classList.add('active');
  const nb=document.querySelector(`.nb[data-page="${id}"]`);
  if(nb) nb.classList.add('active');
  document.getElementById('page-title').textContent=TITLES[id]||id;
  curPage=id;
  // Defer chart rendering until the DOM is painted (fixes 0-size canvas bug)
  requestAnimationFrame(()=>requestAnimationFrame(()=>drawChartsFor(id)));
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CHART ENGINE
   FIX: each render fn creates its own options object (no shared refs)
   FIX: charts map keyed by canvas id - only one chart per canvas
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const CH={};  // chart instances

function kill(id){ if(CH[id]){ CH[id].destroy(); delete CH[id]; } }

// Build fresh options every time â€” no shared object references
function mkOpts(yFmt){
  return {
    responsive:true,
    maintainAspectRatio:false,
    animation:{duration:600},
    plugins:{
      legend:{labels:{font:{family:'DM Sans',size:11},usePointStyle:true,padding:10,boxWidth:10}}
    },
    scales:{
      x:{grid:{color:'rgba(0,0,0,.04)'},ticks:{font:{size:10},maxRotation:45}},
      y:{grid:{color:'rgba(0,0,0,.04)'},ticks:{font:{size:10},
          callback:yFmt||(v=>'$'+Math.round(v).toLocaleString())}}
    }
  };
}

function mkOptsPct(){
  const o=mkOpts(v=>v+'%');
  return o;
}

const C={
  pu:'rgba(123,47,190,1)',   puA:'rgba(123,47,190,.15)',
  gr:'rgba(39,174,96,1)',    grA:'rgba(39,174,96,.15)',
  re:'rgba(231,76,60,1)',    reA:'rgba(231,76,60,.15)',
  go:'rgba(243,156,18,1)',   goA:'rgba(243,156,18,.15)',
  te:'rgba(26,188,156,1)',   teA:'rgba(26,188,156,.15)'
};

// Quarter labels with line break for compact display
const QL=QQ.map(q=>q.split(' '));

/* â”€â”€ Draw all charts for a given page tab â”€â”€ */
function drawChartsFor(id){
  if(id==='dashboard'){ drawMain(); drawAuM(); drawCosts(); drawCash(); }
  if(id==='users')     { drawUsers(); drawAuMU(); }
  if(id==='kpis')      { drawEbitda(); drawGrowth(); }
  if(id==='taxes')     { recalcTax(); }          // recalcTax calls drawTax internally
  if(id==='forecast')  { drawForecast(); }
}

function drawMain(){
  kill('cMain');
  const r=revenue(),o=opex(),n=netInc();
  CH['cMain']=new Chart(document.getElementById('cMain'),{
    type:'bar',
    data:{labels:QL,datasets:[
      {label:'Revenue $K',   data:r, backgroundColor:C.grA,borderColor:C.gr,borderWidth:2,borderRadius:4,order:2},
      {label:'OpEx $K',      data:o.map(v=>-v),backgroundColor:C.reA,borderColor:C.re,borderWidth:2,borderRadius:4,order:2},
      {label:'Net Income $K',data:n, type:'line',borderColor:C.pu,backgroundColor:C.puA,
        fill:true,tension:.4,pointBackgroundColor:n.map(v=>v>=0?C.gr:C.re),pointRadius:4,order:1}
    ]},
    options:{...mkOpts(),interaction:{mode:'index',intersect:false}}
  });
}

function drawAuM(){
  kill('cAum');
  const a=aum();
  CH['cAum']=new Chart(document.getElementById('cAum'),{
    type:'line',
    data:{labels:QL,datasets:[{
      label:'AuM/TVL $K',data:a,
      borderColor:C.pu,backgroundColor:C.puA,fill:true,tension:.4,
      pointBackgroundColor:C.pu,pointRadius:3
    }]},
    options:mkOpts()
  });
}

function drawCosts(){
  kill('cCosts');
  const labels=Object.keys(BC);
  const vals=labels.map(k=>aSum(BC[k],0));
  CH['cCosts']=new Chart(document.getElementById('cCosts'),{
    type:'doughnut',
    data:{labels,datasets:[{
      data:vals,
      backgroundColor:[C.pu,C.gr,C.re,C.go,C.te,'rgba(52,152,219,.85)'],
      borderWidth:2,borderColor:'#fff',hoverOffset:6
    }]},
    options:{
      responsive:true,maintainAspectRatio:false,animation:{duration:600},
      plugins:{legend:{position:'right',labels:{font:{size:10},padding:8,boxWidth:12}}}
    }
  });
}

function drawCash(){
  kill('cCash');
  const cb=cashBal();
  CH['cCash']=new Chart(document.getElementById('cCash'),{
    type:'line',
    data:{labels:QL,datasets:[{
      label:'Cash Balance $K',data:cb,
      borderColor:C.te,backgroundColor:C.teA,fill:true,tension:.4,
      pointBackgroundColor:cb.map(v=>v>=0?C.te:C.re),pointRadius:4
    }]},
    options:mkOpts()
  });
}

function drawUsers(){
  kill('cUsers');
  const u=users();
  CH['cUsers']=new Chart(document.getElementById('cUsers'),{
    type:'bar',
    data:{labels:QL,datasets:[{
      label:'Usuarios',data:u,
      backgroundColor:C.puA,borderColor:C.pu,borderWidth:2,borderRadius:6
    }]},
    options:mkOpts(v=>v.toLocaleString())
  });
}

function drawAuMU(){
  kill('cAumU');
  const u=users(),a=aum();
  const apu=u.map((v,i)=>v>0?Math.round(a[i]/v):0);
  CH['cAumU']=new Chart(document.getElementById('cAumU'),{
    type:'line',
    data:{labels:QL,datasets:[{
      label:'AuM/Usuario $K',data:apu,
      borderColor:C.go,backgroundColor:C.goA,fill:true,tension:.4,
      pointBackgroundColor:C.go,pointRadius:4
    }]},
    options:mkOpts()
  });
}

function drawEbitda(){
  kill('cEbitda');
  const r=revenue(),n=netInc();
  const yr=['2026','2027','2028','2029'];
  const m=yr.map((_,i)=>{ const rv=aSum(r,i); return rv>0?+(aSum(n,i)/rv*100).toFixed(1):0; });
  CH['cEbitda']=new Chart(document.getElementById('cEbitda'),{
    type:'bar',
    data:{labels:yr,datasets:[{
      label:'EBITDA Margin %',data:m,
      backgroundColor:m.map(v=>v>=0?C.grA:C.reA),
      borderColor:m.map(v=>v>=0?C.gr:C.re),borderWidth:2,borderRadius:8
    }]},
    options:mkOptsPct()
  });
}

function drawGrowth(){
  kill('cGrowth');
  const r=revenue();
  const yr=['2026','2027','2028','2029'];
  const rv=yr.map((_,i)=>aSum(r,i));
  const g=rv.map((v,i)=>i>0?+(((v-rv[i-1])/Math.abs(rv[i-1]))*100).toFixed(1):0);
  CH['cGrowth']=new Chart(document.getElementById('cGrowth'),{
    type:'line',
    data:{labels:yr,datasets:[{
      label:'Revenue YoY %',data:g,
      borderColor:C.pu,backgroundColor:C.puA,fill:true,tension:.4,
      pointBackgroundColor:C.pu,pointRadius:6
    }]},
    options:mkOptsPct()
  });
}

function drawTax(payES,payOt){
  kill('cTax');
  const yr=['2026','2027','2028','2029'];
  const es=yr.map((_,i)=>Math.abs(aSum(payES,i)));
  const ot=yr.map((_,i)=>Math.abs(aSum(payOt,i)));
  CH['cTax']=new Chart(document.getElementById('cTax'),{
    type:'bar',
    data:{labels:yr,datasets:[
      {label:'ğŸ‡ªğŸ‡¸ IS EspaÃ±a $K',data:es,backgroundColor:C.puA,borderColor:C.pu,borderWidth:2,borderRadius:6},
      {label:'ğŸŒ Tax Alt. $K', data:ot,backgroundColor:C.goA,borderColor:C.go,borderWidth:2,borderRadius:6}
    ]},
    options:mkOpts()
  });
}

function drawForecast(){
  kill('cFc');
  // Compute the forecast data fresh
  const r=revenue(),o=opex(),n=netInc(),cb=cashBal();
  const yr=['2026','2027','2028','2029'];
  const Y=yr.map((_,i)=>({rev:aSum(r,i),net:aSum(n,i),cash:cb[i*4+3]}));
  const rev30=Math.round(Y[3].rev*1.30);
  const opx30=Math.round(aSum(o,3)*1.05);
  const net30=rev30-opx30;
  const csh30=cb[15]+net30+MA[15];

  const labels=['2026','2027','2028','2029','2030E'];
  const revY=Y.map(y=>y.rev).concat([rev30]);
  const netY=Y.map(y=>y.net).concat([net30]);
  const cshY=Y.map(y=>y.cash).concat([csh30]);

  CH['cFc']=new Chart(document.getElementById('cFc'),{
    type:'bar',
    data:{labels,datasets:[
      {label:'Revenue $K',data:revY,backgroundColor:C.grA,borderColor:C.gr,borderWidth:2,borderRadius:6,order:2},
      {label:'Net Income $K',data:netY,
        backgroundColor:netY.map(v=>v>=0?C.puA:C.reA),
        borderColor:netY.map(v=>v>=0?C.pu:C.re),borderWidth:2,borderRadius:6,order:2},
      {label:'Cash Balance $K',data:cshY,type:'line',
        borderColor:C.te,backgroundColor:'transparent',tension:.4,
        pointBackgroundColor:cshY.map(v=>v>=0?C.te:C.re),pointRadius:6,order:1}
    ]},
    options:{...mkOpts(),interaction:{mode:'index',intersect:false}}
  });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TABLE RENDERERS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderPL(){
  const r=revenue(),o=opex(),n=netInc(),cb=cashBal(),a=aum(),u=users();
  const th=QQ.map(q=>`<th>${q.replace(' ','<br>')}</th>`).join('');
  document.getElementById('pl-h').innerHTML=`<tr><th>Partida ($000s)</th>${th}</tr>`;
  const rows=[
    {l:'ğŸ‘¥ Usuarios',      d:u,  cf:()=>''},
    {l:'ğŸ’ AuM / TVL',     d:a,  cf:()=>'pu'},
    {l:'APR (%)',           d:APR.map(v=>(v*100).toFixed(0)+'%'), cf:()=>'',raw:true},
    {l:'âœ… Protocol Revenue',d:r, cf:()=>'p'},
    {l:'Total OpEx',        d:o,  cf:()=>'n'},
    {l:'ğŸ“Š NET INCOME',     d:n,  cf:v=>nc(v), bold:true},
    {l:'Capital Raise',     d:CAP,cf:v=>v?'pu':''},
    {l:'M&amp;A',           d:MA, cf:()=>'n'},
    {l:'ğŸ’µ Cash Balance',   d:cb, cf:v=>nc(v), bold:true}
  ];
  document.getElementById('pl-b').innerHTML=rows.map(row=>{
    const cells=row.d.map((v,i)=>{
      const cl=row.cf(v); const disp=row.raw?v:(typeof v==='number'?fmtK(v):v);
      return `<td class="${cl}">${disp}</td>`;
    }).join('');
    return `<tr${row.bold?' style="font-weight:700"':''}><td>${row.l}</td>${cells}</tr>`;
  }).join('');
}

function renderCostsTable(){
  const o=opex();
  const qs=QQ.map(q=>q.slice(0,2)+q.slice(-2));
  const th=qs.map(q=>`<th>${q}</th>`).join('');
  document.getElementById('cost-h').innerHTML=`<tr><th>Partida ($000s)</th>${th}<th>Tot 26</th><th>Tot 27</th><th>Tot 28</th><th>Tot 29</th></tr>`;
  let html='';
  for(const[k,v] of Object.entries(BC)){
    const cells=v.map(x=>`<td>${fmtK(x)}</td>`).join('');
    const tots=[0,1,2,3].map(y=>`<td class="n">${fmtK(aSum(v,y))}</td>`).join('');
    html+=`<tr><td>${k}</td>${cells}${tots}</tr>`;
  }
  const ac=cAdj.map((v,i)=>`<td class="${v>0?'n':v<0?'p':''}">${v!==0?fmtK(v):'â€”'}</td>`).join('');
  const at=[0,1,2,3].map(y=>`<td class="${aSum(cAdj,y)>0?'n':aSum(cAdj,y)<0?'p':''}">${aSum(cAdj,y)!==0?fmtK(aSum(cAdj,y)):'â€”'}</td>`).join('');
  html+=`<tr style="background:var(--pup)"><td>âœï¸ Ajustes Manuales</td>${ac}${at}</tr>`;
  const tc=o.map(v=>`<td class="n"><strong>${fmtK(v)}</strong></td>`).join('');
  const tt=[0,1,2,3].map(y=>`<td class="n"><strong>${fmtK(aSum(o,y))}</strong></td>`).join('');
  html+=`<tr class="rt"><td>TOTAL OpEx</td>${tc}${tt}</tr>`;
  document.getElementById('cost-b').innerHTML=html;
}

function renderUsersTable(){
  const u=users(),a=aum(),r=revenue();
  const th=QQ.map(q=>`<th>${q.replace(' ','<br>')}</th>`).join('');
  document.getElementById('usr-h').innerHTML=`<tr><th>MÃ©trica</th>${th}</tr>`;
  document.getElementById('usr-b').innerHTML=[
    {l:'ğŸ‘¥ Usuarios',      d:u, fn:v=>v.toLocaleString(), cf:()=>''},
    {l:'ğŸ’ AuM/TVL ($K)',  d:a, fn:fmtK, cf:()=>'pu'},
    {l:'ğŸ“ˆ Revenue ($K)',  d:r, fn:fmtK, cf:()=>'p'}
  ].map(row=>`<tr><td>${row.l}</td>${row.d.map(v=>`<td class="${row.cf(v)}">${row.fn(v)}</td>`).join('')}</tr>`).join('');
}

function renderKPIsPage(){
  const r=revenue(),o=opex(),n=netInc(),a=aum(),u=users(),cb=cashBal();
  const yrs=['2026','2027','2028','2029'];
  const Y=yrs.map((_,i)=>({
    rev:aSum(r,i),opex:aSum(o,i),net:aSum(n,i),
    aum:Math.max(...a.slice(i*4,i*4+4)),
    usr:Math.max(...u.slice(i*4,i*4+4)),
    cash:cb[i*4+3]
  }));
  const bk=n.findIndex(v=>v>0);

  document.getElementById('kpi-strat').innerHTML=`
    <div class="kc cp"><span class="ki">ğŸš€</span>
      <div class="kl">Breakeven Quarter</div>
      <div class="kv" style="font-size:17px">${bk>=0?QQ[bk]:'TBD'}</div>
      <div class="kd pos">Primer trimestre positivo</div></div>
    <div class="kc cg"><span class="ki">ğŸ’°</span>
      <div class="kl">Revenue 2027</div>
      <div class="kv">${fmt(Y[1].rev)}</div>
      <div class="kd pos">â†‘ +${((Y[1].rev-Y[0].rev)/Math.abs(Y[0].rev)*100).toFixed(0)}% vs 2026</div></div>
    <div class="kc co"><span class="ki">ğŸ¯</span>
      <div class="kl">Max Cash Balance</div>
      <div class="kv">${fmt(Math.max(...cb))}</div>
      <div class="kd pos">En ${QQ[cb.indexOf(Math.max(...cb))]}</div></div>
    <div class="kc ct"><span class="ki">ğŸ‘¥</span>
      <div class="kl">Usuarios 2029</div>
      <div class="kv">${Y[3].usr.toLocaleString()}</div>
      <div class="kd pos">â†‘ +${((Y[3].usr-Y[0].usr)/Y[0].usr*100).toFixed(0)}% vs 2026</div></div>`;

  document.getElementById('kpi-h').innerHTML=`<tr><th>KPI</th>${yrs.map(y=>`<th>${y}</th>`).join('')}<th>CAGR 26â†’29</th></tr>`;
  const krows=[
    {l:'ğŸ“ˆ Revenue ($K)',   vf:(y)=>fmtK(y.rev),  cf:()=>'p',    cagr:Y[3].rev/Y[0].rev},
    {l:'ğŸ’¸ OpEx ($K)',      vf:(y)=>fmtK(y.opex), cf:()=>'n',    cagr:Y[3].opex/Y[0].opex},
    {l:'ğŸ“Š Net Income ($K)',vf:(y)=>fmtK(y.net),  cf:y=>nc(y.net),cagr:null},
    {l:'EBITDA Margin',    vf:(y)=>y.rev>0?(y.net/y.rev*100).toFixed(1)+'%':'N/A',cf:()=>'',cagr:null},
    {l:'ğŸ’ AuM Peak ($K)', vf:(y)=>fmtK(y.aum),  cf:()=>'pu',   cagr:Y[3].aum/Y[0].aum},
    {l:'ğŸ‘¥ Peak Users',    vf:(y)=>y.usr.toLocaleString(),cf:()=>'',cagr:Y[3].usr/Y[0].usr},
    {l:'ğŸ’µ Cash YE ($K)',  vf:(y)=>fmtK(y.cash), cf:y=>nc(y.cash),cagr:null}
  ];
  document.getElementById('kpi-b').innerHTML=krows.map(row=>{
    const cells=Y.map(y=>`<td class="${row.cf(y)}">${row.vf(y)}</td>`).join('');
    const cg=row.cagr?`<td class="p">${((Math.pow(row.cagr,1/3)-1)*100).toFixed(0)}%</td>`:'<td>â€”</td>';
    return `<tr><td>${row.l}</td>${cells}${cg}</tr>`;
  }).join('');
}

function renderForecastPage(){
  const r=revenue(),o=opex(),n=netInc(),a=aum(),u=users(),cb=cashBal();
  const yr=['2026','2027','2028','2029'];
  const Y=yr.map((_,i)=>({
    rev:aSum(r,i),opex:aSum(o,i),net:aSum(n,i),
    aum:Math.max(...a.slice(i*4,i*4+4)),
    usr:Math.max(...u.slice(i*4,i*4+4)),
    cash:cb[i*4+3]
  }));
  const rev30=Math.round(Y[3].rev*1.30);
  const opx30=Math.round(Y[3].opex*1.05);
  const net30=rev30-opx30;
  const aum30=Math.round(Y[3].aum*1.40);
  const usr30=Math.round(Y[3].usr*1.35);
  const csh30=cb[15]+net30+MA[15];

  document.getElementById('kpi-fc').innerHTML=`
    <div class="kc cp"><span class="ki">ğŸ†</span>
      <div class="kl">Revenue Total 5Y</div>
      <div class="kv">${fmt(Y.reduce((s,y)=>s+y.rev,0)+rev30)}</div></div>
    <div class="kc cg"><span class="ki">ğŸ’°</span>
      <div class="kl">Net Income 2030E</div>
      <div class="kv">${fmt(net30)}</div>
      <div class="kd pos">+30% Revenue proyectado</div></div>
    <div class="kc co"><span class="ki">ğŸ’</span>
      <div class="kl">AuM 2030E</div>
      <div class="kv">${fmt(aum30)}</div></div>
    <div class="kc ct"><span class="ki">ğŸ‘¥</span>
      <div class="kl">Usuarios 2030E</div>
      <div class="kv">${usr30.toLocaleString()}</div></div>`;

  document.getElementById('fc-h').innerHTML='<tr><th>MÃ©trica ($000s)</th><th>2026</th><th>2027</th><th>2028</th><th>2029</th><th>2030E ğŸ”®</th></tr>';
  const E={rev:rev30,opex:opx30,net:net30,aum:aum30,usr:usr30,cash:csh30};
  const fcr=[
    {l:'ğŸ“ˆ Revenue',   vs:Y.map(y=>fmtK(y.rev)).concat([fmtK(E.rev)]),   cls:Y.map(()=>'p').concat(['p'])},
    {l:'ğŸ’¸ OpEx',      vs:Y.map(y=>fmtK(y.opex)).concat([fmtK(E.opex)]), cls:Y.map(()=>'n').concat(['n'])},
    {l:'ğŸ“Š Net Income',vs:Y.map(y=>fmtK(y.net)).concat([fmtK(E.net)]),   cls:Y.map(y=>nc(y.net)).concat([nc(E.net)])},
    {l:'ğŸ’µ Cash YE',   vs:Y.map(y=>fmtK(y.cash)).concat([fmtK(E.cash)]),cls:Y.map(y=>nc(y.cash)).concat([nc(E.cash)])},
    {l:'ğŸ’ AuM Peak',  vs:Y.map(y=>fmtK(y.aum)).concat([fmtK(E.aum)]),  cls:Y.map(()=>'pu').concat(['pu'])},
    {l:'ğŸ‘¥ Peak Users',vs:Y.map(y=>y.usr.toLocaleString()).concat([E.usr.toLocaleString()]),cls:Array(5).fill('')},
    {l:'EBITDA %',     vs:Y.map(y=>y.rev>0?(y.net/y.rev*100).toFixed(1)+'%':'N/A').concat([(E.net/E.rev*100).toFixed(1)+'%']),cls:Array(5).fill('')}
  ];
  document.getElementById('fc-b').innerHTML=fcr.map(row=>{
    const cells=row.vs.map((v,i)=>`<td class="${row.cls[i]}"${i===4?' style="background:var(--pup)"':''}>${v}</td>`).join('');
    return `<tr><td>${row.l}</td>${cells}</tr>`;
  }).join('');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TAX CALCULATOR
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function recalcTax(){
  const tES=parseFloat(document.getElementById('tx-es-c').value)/100||.25;
  const mth=parseFloat(document.getElementById('tx-es-m').value)||.40;
  const tOt=parseFloat(document.getElementById('tx-ot-e').value)/100||.09;
  const n=netInc();
  const pES=n.map(v=>v>0?-Math.round(v*tES*mth):0);
  const pOt=n.map(v=>v>0?-Math.round(v*tOt):0);
  const aft=n.map((v,i)=>v+pES[i]);
  const otName=document.getElementById('tx-ot-n').value||'Alternativo';

  const qs=QQ.map(q=>q.slice(0,2)+q.slice(-2));
  const th=qs.map(q=>`<th>${q}</th>`).join('');
  document.getElementById('tax-h').innerHTML=`<tr><th>Concepto ($000s)</th>${th}<th>Tot 26</th><th>Tot 27</th><th>Tot 28</th><th>Tot 29</th></tr>`;
  const trows=[
    {l:'Net Income (pre-tax)',      v:n,  cf:v=>nc(v)},
    {l:'ğŸ‡ªğŸ‡¸ IS Pago Fracc. EspaÃ±a', v:pES,cf:()=>'n'},
    {l:`ğŸŒ Tax Alt. (${otName})`,   v:pOt,cf:()=>'n'},
    {l:'âœ… Net Income post-tax',     v:aft,cf:v=>nc(v)}
  ];
  document.getElementById('tax-b').innerHTML=trows.map(row=>{
    const cells=row.v.map(v=>`<td class="${row.cf(v)}">${v!==0?fmtK(v):'â€”'}</td>`).join('');
    const tots=[0,1,2,3].map(y=>aSum(row.v,y)).map(v=>`<td class="${row.cf(v)}">${v!==0?fmtK(v):'â€”'}</td>`).join('');
    return `<tr><td>${row.l}</td>${cells}${tots}</tr>`;
  }).join('');

  // Draw tax chart (only if visible)
  if(curPage==='taxes') drawTax(pES,pOt);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INPUTS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function buildUserInputs(){
  const u=users();
  document.getElementById('user-inp').innerHTML=QQ.map((q,i)=>`
    <div class="igrp">
      <label class="ilbl">${q}</label>
      <input class="if" id="ui${i}" type="number" value="${u[i]}" min="0" step="10"
        oninput="uDelta[${i}]=(parseInt(this.value)||0)-${BU[i]};recalcAll()">
    </div>`).join('');
}

function buildCostInputs(){
  document.getElementById('cost-inp').innerHTML=QQ.map((q,i)=>`
    <div class="igrp">
      <label class="ilbl">${q}</label>
      <div class="iw"><span class="ipfx">$</span>
        <input class="if pfx" id="ci${i}" type="number" value="${cAdj[i]}" step="10"
          oninput="cAdj[${i}]=parseFloat(this.value)||0;recalcAll()">
      </div>
    </div>`).join('');
}

function resetUsers(){ uDelta=Array(16).fill(0); buildUserInputs(); recalcAll(); }
function resetCosts(){ cAdj=Array(16).fill(0);   buildCostInputs(); recalcAll(); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MASTER KPI CARDS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderDashKPIs(){
  const r=revenue(),o=opex(),n=netInc(),cb=cashBal(),a=aum(),u=users();
  const y0r=aSum(r,0),y1r=aSum(r,1),y0o=aSum(o,0),y0n=aSum(n,0),y0a=aSum(a,0);
  const pct=y0r!==0?((y1r-y0r)/Math.abs(y0r)*100).toFixed(0):0;
  const bk=n.findIndex(v=>v>0);
  document.getElementById('kpi-dash').innerHTML=`
    <div class="kc cp"><span class="ki">ğŸ’</span>
      <div class="kl">AuM/TVL Total 2026</div>
      <div class="kv">${fmt(y0a)}</div>
      <div class="kd pos">â†‘ Escenario $10M</div></div>
    <div class="kc cg"><span class="ki">ğŸ“ˆ</span>
      <div class="kl">Protocol Revenue 2026</div>
      <div class="kv">${fmt(y0r)}</div>
      <div class="kd pos">+${pct}% YoY â†’ 2027</div></div>
    <div class="kc cr"><span class="ki">ğŸ’¸</span>
      <div class="kl">Total OpEx 2026</div>
      <div class="kv">${fmt(y0o)}</div>
      <div class="kd neg">â†“ InversiÃ³n inicial</div></div>
    <div class="kc co"><span class="ki">ğŸ¦</span>
      <div class="kl">Net Income 2026</div>
      <div class="kv">${fmt(y0n)}</div>
      <div class="kd ${y0n>=0?'pos':'neg'}">${y0n>=0?'â†‘ Beneficio':'â†“ AÃ±o de arranque'}</div></div>
    <div class="kc ct"><span class="ki">ğŸ’µ</span>
      <div class="kl">Cash Balance Q4 2026</div>
      <div class="kv">${fmt(cb[3])}</div>
      <div class="kd ${cb[3]>=0?'pos':'neg'}">+ Capital raise $10M</div></div>
    <div class="kc cp"><span class="ki">ğŸ‘¤</span>
      <div class="kl">Usuarios Q4 2026</div>
      <div class="kv">${u[3].toLocaleString()}</div>
      <div class="kd pos">Breakeven: ${bk>=0?QQ[bk]:'TBD'}</div></div>`;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MASTER RECALC
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function recalcAll(){
  renderDashKPIs();
  renderPL();
  renderCostsTable();
  renderUsersTable();
  renderKPIsPage();
  renderForecastPage();
  recalcTax();
  // Redraw charts for current visible page
  requestAnimationFrame(()=>drawChartsFor(curPage));
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   EXPORT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function doExportCSV(){
  const r=revenue(),o=opex(),n=netInc(),cb=cashBal(),a=aum(),u=users();
  let s='Stabolut Financial Model â€” $10M Round\n\n';
  s+='Metric,'+QQ.join(',')+'\n';
  s+=`Users,${u.join(',')}\n`;
  s+=`AuM/TVL ($K),${a.join(',')}\n`;
  s+=`APR (%),${APR.map(v=>(v*100).toFixed(0)+'%').join(',')}\n`;
  s+=`Revenue ($K),${r.join(',')}\n`;
  s+=`OpEx ($K),${o.join(',')}\n`;
  s+=`Net Income ($K),${n.join(',')}\n`;
  s+=`Capital Raise ($K),${CAP.join(',')}\n`;
  s+=`M&A ($K),${MA.join(',')}\n`;
  s+=`Cash Balance ($K),${cb.join(',')}\n`;
  for(const[k,v] of Object.entries(BC)) s+=`${k} ($K),${v.join(',')}\n`;
  const bl=new Blob([s],{type:'text/csv;charset=utf-8;'});
  const a2=document.createElement('a');
  a2.href=URL.createObjectURL(bl);
  a2.download='Stabolut_Model.csv';
  a2.click();
}

function doExportExcel(){
  if(typeof XLSX==='undefined'){
    alert('La librerÃ­a Excel no estÃ¡ disponible. Verifica la conexiÃ³n a internet.');
    return;
  }
  const r=revenue(),o=opex(),n=netInc(),cb=cashBal(),a=aum(),u=users();
  const wb=XLSX.utils.book_new();

  XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet([
    ['STABOLUT â€” FINANCIAL MODEL Â· $10M Round'],
    ['Generado: '+new Date().toLocaleDateString('es-ES')],[],
    ['Metric ($000s)',...QQ],
    ['Users',...u],['AuM/TVL',...a],
    ['APR (%)',...APR.map(v=>(v*100).toFixed(0)+'%')],
    ['Revenue',...r],['Total OpEx',...o],['Net Income',...n],
    ['Capital Raise',...CAP],['M&A',...MA],['Cash Balance',...cb]
  ]),'P&L Trimestral');

  const cs=[['Cost Item ($000s)',...QQ,'Total 26','Total 27','Total 28','Total 29']];
  for(const[k,v] of Object.entries(BC)) cs.push([k,...v,...[0,1,2,3].map(y=>aSum(v,y))]);
  cs.push(['Ajustes Manuales',...cAdj,...[0,1,2,3].map(y=>aSum(cAdj,y))]);
  cs.push(['TOTAL OpEx',...o,...[0,1,2,3].map(y=>aSum(o,y))]);
  XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet(cs),'Costes');

  const Y=[0,1,2,3].map(i=>({rev:aSum(r,i),opx:aSum(o,i),net:aSum(n,i),cash:cb[i*4+3]}));
  const rev30=Math.round(Y[3].rev*1.30),opx30=Math.round(Y[3].opx*1.05);
  XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet([
    ['Annual Summary ($000s)','2026','2027','2028','2029','2030E'],
    ['Revenue',...Y.map(y=>y.rev),rev30],
    ['OpEx',...Y.map(y=>y.opx),opx30],
    ['Net Income',...Y.map(y=>y.net),rev30-opx30],
    ['Cash Balance YE',...Y.map(y=>y.cash),cb[15]+rev30-opx30+MA[15]]
  ]),'Resumen Anual');

  XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet([
    ['Quarter',...QQ],['Users',...u],['User Delta',...uDelta],['AuM/TVL',...a]
  ]),'Usuarios');

  XLSX.writeFile(wb,'Stabolut_Financial_Model.xlsx');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INIT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
document.addEventListener('DOMContentLoaded',()=>{
  const d=new Date().toLocaleDateString('es-ES',{day:'2-digit',month:'long',year:'numeric'});
  document.getElementById('hdate').textContent='Actualizado: '+d;
  document.getElementById('fdate').textContent=d;

  buildUserInputs();
  buildCostInputs();

  // Render all data tables
  renderDashKPIs();
  renderPL();
  renderCostsTable();
  renderUsersTable();
  renderKPIsPage();
  renderForecastPage();
  recalcTax();

  // Draw dashboard charts after two animation frames
  // (ensures CSS layout is fully calculated, canvas has real dimensions)
  requestAnimationFrame(()=>requestAnimationFrame(()=>{
    drawMain();
    drawAuM();
    drawCosts();
    drawCash();
  }));
});
</script>
</body>
</html>
