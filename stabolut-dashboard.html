<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Stabolut â€” Financial Dashboard</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
<style>
  :root {
    --purple: #7B2FBE;
    --purple-light: #9B59D0;
    --purple-pale: #F3EAFB;
    --purple-mid: #E8D5F7;
    --green: #27AE60;
    --green-pale: #E8F8EF;
    --red: #E74C3C;
    --red-pale: #FDECEA;
    --gold: #F39C12;
    --gold-pale: #FEF9E7;
    --gray-100: #F8F9FA;
    --gray-200: #EEF0F3;
    --gray-300: #DEE2E9;
    --gray-500: #8892A0;
    --gray-700: #4A5568;
    --gray-900: #1A202C;
    --bg: #F6F7FB;
    --card-bg: #FFFFFF;
    --shadow: 0 2px 12px rgba(123,47,190,0.08);
    --shadow-hover: 0 6px 28px rgba(123,47,190,0.16);
    --radius: 16px;
    --radius-sm: 10px;
    --font: 'DM Sans', sans-serif;
    --font-mono: 'Space Mono', monospace;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }
  
  body {
    font-family: var(--font);
    background: var(--bg);
    color: var(--gray-900);
    min-height: 100vh;
  }

  /* â”€â”€ SIDEBAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .layout { display: flex; min-height: 100vh; }

  .sidebar {
    width: 240px;
    min-width: 240px;
    background: #fff;
    border-right: 1.5px solid var(--gray-200);
    display: flex;
    flex-direction: column;
    position: sticky;
    top: 0;
    height: 100vh;
    z-index: 100;
    overflow-y: auto;
  }

  .sidebar-logo {
    padding: 28px 24px 20px;
    border-bottom: 1px solid var(--gray-200);
  }

  .sidebar-logo img { height: 36px; }

  .sidebar-badge {
    display: inline-block;
    margin-top: 8px;
    font-size: 10px;
    font-weight: 700;
    letter-spacing: 1px;
    text-transform: uppercase;
    color: var(--purple);
    background: var(--purple-pale);
    padding: 3px 8px;
    border-radius: 20px;
  }

  .sidebar-nav {
    padding: 16px 12px;
    flex: 1;
  }

  .nav-label {
    font-size: 10px;
    font-weight: 600;
    letter-spacing: 1.5px;
    text-transform: uppercase;
    color: var(--gray-500);
    padding: 12px 12px 6px;
  }

  .nav-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 12px;
    border-radius: var(--radius-sm);
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    color: var(--gray-700);
    transition: all 0.18s;
    border: none;
    background: none;
    width: 100%;
    text-align: left;
    text-decoration: none;
  }

  .nav-item:hover { background: var(--purple-pale); color: var(--purple); }
  .nav-item.active { background: var(--purple); color: #fff; }
  .nav-item .icon { font-size: 16px; width: 20px; text-align: center; }

  /* â”€â”€ MAIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .main {
    flex: 1;
    min-width: 0;
    padding: 0;
    overflow-x: hidden;
  }

  .topbar {
    background: #fff;
    border-bottom: 1.5px solid var(--gray-200);
    padding: 16px 32px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    position: sticky;
    top: 0;
    z-index: 50;
  }

  .topbar-title { font-size: 20px; font-weight: 700; color: var(--gray-900); }
  .topbar-subtitle { font-size: 13px; color: var(--gray-500); margin-top: 2px; }

  .topbar-actions { display: flex; gap: 10px; align-items: center; }

  .btn {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 9px 18px;
    border-radius: var(--radius-sm);
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    border: none;
    transition: all 0.18s;
    text-decoration: none;
  }

  .btn-primary { background: var(--purple); color: #fff; }
  .btn-primary:hover { background: var(--purple-light); box-shadow: 0 4px 16px rgba(123,47,190,0.3); }
  .btn-outline { background: #fff; color: var(--purple); border: 1.5px solid var(--purple); }
  .btn-outline:hover { background: var(--purple-pale); }
  .btn-ghost { background: var(--gray-100); color: var(--gray-700); }
  .btn-ghost:hover { background: var(--gray-200); }

  /* â”€â”€ TABS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .page { display: none; padding: 28px 32px 40px; }
  .page.active { display: block; }

  /* â”€â”€ CARDS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .card {
    background: var(--card-bg);
    border-radius: var(--radius);
    padding: 24px;
    box-shadow: var(--shadow);
    border: 1px solid var(--gray-200);
    transition: box-shadow 0.18s;
  }
  .card:hover { box-shadow: var(--shadow-hover); }

  .card-title {
    font-size: 13px;
    font-weight: 600;
    letter-spacing: 0.5px;
    text-transform: uppercase;
    color: var(--gray-500);
    margin-bottom: 8px;
  }

  /* â”€â”€ KPI GRID â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .kpi-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
    margin-bottom: 24px;
  }

  .kpi-card {
    background: var(--card-bg);
    border-radius: var(--radius);
    padding: 20px 24px;
    border: 1px solid var(--gray-200);
    box-shadow: var(--shadow);
    position: relative;
    overflow: hidden;
    transition: all 0.2s;
  }
  .kpi-card:hover { box-shadow: var(--shadow-hover); transform: translateY(-2px); }

  .kpi-card::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 4px;
    border-radius: var(--radius) var(--radius) 0 0;
  }
  .kpi-card.purple::before { background: linear-gradient(90deg, var(--purple), var(--purple-light)); }
  .kpi-card.green::before { background: linear-gradient(90deg, #27AE60, #2ECC71); }
  .kpi-card.red::before { background: linear-gradient(90deg, #E74C3C, #F1948A); }
  .kpi-card.gold::before { background: linear-gradient(90deg, #F39C12, #F7DC6F); }
  .kpi-card.teal::before { background: linear-gradient(90deg, #1ABC9C, #48C9B0); }

  .kpi-label { font-size: 12px; font-weight: 600; color: var(--gray-500); text-transform: uppercase; letter-spacing: 0.5px; }
  .kpi-value { font-size: 26px; font-weight: 700; color: var(--gray-900); margin: 6px 0 4px; font-family: var(--font-mono); }
  .kpi-delta { font-size: 12px; font-weight: 600; }
  .kpi-delta.pos { color: var(--green); }
  .kpi-delta.neg { color: var(--red); }
  .kpi-icon { position: absolute; right: 18px; top: 18px; font-size: 28px; opacity: 0.15; }

  /* â”€â”€ CHARTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .charts-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(340px, 1fr));
    gap: 20px;
    margin-bottom: 24px;
  }

  .chart-card {
    background: var(--card-bg);
    border-radius: var(--radius);
    padding: 24px;
    border: 1px solid var(--gray-200);
    box-shadow: var(--shadow);
  }

  .chart-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 18px;
  }

  .chart-title { font-size: 15px; font-weight: 700; color: var(--gray-900); }
  .chart-sub { font-size: 12px; color: var(--gray-500); margin-top: 2px; }

  .chart-canvas { position: relative; height: 240px; }

  /* â”€â”€ TABLES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .table-wrap { overflow-x: auto; border-radius: var(--radius-sm); }

  table { width: 100%; border-collapse: collapse; font-size: 13px; }
  thead th {
    background: var(--purple-pale);
    color: var(--purple);
    font-weight: 700;
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    padding: 10px 14px;
    text-align: right;
    white-space: nowrap;
  }
  thead th:first-child { text-align: left; border-radius: var(--radius-sm) 0 0 0; }
  thead th:last-child { border-radius: 0 var(--radius-sm) 0 0; }

  tbody tr { border-bottom: 1px solid var(--gray-200); transition: background 0.12s; }
  tbody tr:hover { background: var(--gray-100); }
  tbody td { padding: 10px 14px; text-align: right; color: var(--gray-700); white-space: nowrap; }
  tbody td:first-child { text-align: left; font-weight: 600; color: var(--gray-900); }

  .td-pos { color: var(--green) !important; font-weight: 700; }
  .td-neg { color: var(--red) !important; font-weight: 700; }
  .td-purple { color: var(--purple) !important; font-weight: 700; }

  .section-title {
    font-size: 18px;
    font-weight: 700;
    color: var(--gray-900);
    margin: 28px 0 16px;
    display: flex;
    align-items: center;
    gap: 10px;
  }
  .section-title::after {
    content: '';
    flex: 1;
    height: 2px;
    background: var(--gray-200);
  }

  /* â”€â”€ FORM INPUTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .inputs-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 20px;
    margin-bottom: 24px;
  }

  .input-group { margin-bottom: 14px; }
  .input-label {
    font-size: 12px;
    font-weight: 600;
    color: var(--gray-700);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 6px;
    display: block;
  }

  .input-field {
    width: 100%;
    padding: 10px 14px;
    border: 1.5px solid var(--gray-300);
    border-radius: var(--radius-sm);
    font-family: var(--font);
    font-size: 14px;
    color: var(--gray-900);
    background: #fff;
    transition: border-color 0.18s, box-shadow 0.18s;
    outline: none;
  }

  .input-field:focus {
    border-color: var(--purple);
    box-shadow: 0 0 0 3px rgba(123,47,190,0.1);
  }

  .input-prefix {
    position: relative;
  }
  .input-prefix span {
    position: absolute;
    left: 12px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 14px;
    font-weight: 600;
    color: var(--gray-500);
    pointer-events: none;
  }
  .input-prefix .input-field { padding-left: 28px; }

  .tag {
    display: inline-block;
    padding: 3px 10px;
    border-radius: 20px;
    font-size: 11px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  .tag-green { background: var(--green-pale); color: var(--green); }
  .tag-red { background: var(--red-pale); color: var(--red); }
  .tag-purple { background: var(--purple-pale); color: var(--purple); }
  .tag-gold { background: var(--gold-pale); color: var(--gold); }

  .alert-info {
    background: var(--purple-pale);
    border-left: 4px solid var(--purple);
    border-radius: 8px;
    padding: 12px 16px;
    font-size: 13px;
    color: var(--purple);
    margin-bottom: 16px;
    font-weight: 500;
  }

  .divider { height: 1px; background: var(--gray-200); margin: 24px 0; }

  /* â”€â”€ QUARTERLY BADGES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .q-positive { background: #E8F8EF; color: #27AE60; padding: 3px 8px; border-radius: 6px; font-weight: 700; font-size: 12px; }
  .q-negative { background: #FDECEA; color: #E74C3C; padding: 3px 8px; border-radius: 6px; font-weight: 700; font-size: 12px; }

  /* â”€â”€ RESPONSIVE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .hamburger { display: none; }

  @media (max-width: 900px) {
    .sidebar { display: none; position: fixed; z-index: 200; height: 100vh; box-shadow: 0 0 40px rgba(0,0,0,0.2); }
    .sidebar.open { display: flex; }
    .hamburger { display: flex; align-items: center; gap: 6px; background: none; border: none; cursor: pointer; font-size: 22px; color: var(--gray-700); padding: 4px; }
    .page { padding: 16px; }
    .topbar { padding: 12px 16px; }
    .charts-grid { grid-template-columns: 1fr; }
  }

  @media (max-width: 600px) {
    .kpi-grid { grid-template-columns: repeat(2, 1fr); }
    .inputs-grid { grid-template-columns: 1fr; }
    .topbar-actions { gap: 6px; }
  }

  /* â”€â”€ SCENARIOS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .scenario-badge {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 6px 14px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 700;
    letter-spacing: 0.5px;
    text-transform: uppercase;
  }
  .scenario-active { background: var(--purple); color: #fff; }

  /* â”€â”€ FOOTER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .footer-bar {
    background: #fff;
    border-top: 1px solid var(--gray-200);
    padding: 14px 32px;
    font-size: 12px;
    color: var(--gray-500);
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  /* User manual input highlight */
  .manual-input-card {
    border: 2px dashed var(--purple-light);
    background: var(--purple-pale);
  }

  .recalc-notice {
    background: linear-gradient(135deg, #7B2FBE10, #27AE6010);
    border: 1px solid var(--purple-mid);
    border-radius: var(--radius-sm);
    padding: 10px 14px;
    font-size: 12px;
    color: var(--gray-700);
    margin-top: 10px;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  /* Tab nav pills */
  .tab-pills {
    display: flex;
    gap: 6px;
    padding: 4px;
    background: var(--gray-100);
    border-radius: 12px;
    margin-bottom: 24px;
    flex-wrap: wrap;
  }

  .tab-pill {
    padding: 8px 16px;
    border-radius: 9px;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    border: none;
    background: none;
    color: var(--gray-500);
    transition: all 0.18s;
  }

  .tab-pill.active {
    background: var(--card-bg);
    color: var(--purple);
    box-shadow: 0 2px 8px rgba(123,47,190,0.1);
  }

  /* â”€â”€ PROGRESS BARS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .progress-bar {
    height: 8px;
    background: var(--gray-200);
    border-radius: 10px;
    overflow: hidden;
    margin-top: 8px;
  }
  .progress-fill {
    height: 100%;
    border-radius: 10px;
    background: linear-gradient(90deg, var(--purple), var(--purple-light));
    transition: width 0.8s ease;
  }
  .progress-fill.green { background: linear-gradient(90deg, #27AE60, #2ECC71); }
  .progress-fill.red { background: linear-gradient(90deg, #E74C3C, #F1948A); }
  .progress-fill.gold { background: linear-gradient(90deg, #F39C12, #F7DC6F); }
</style>
</head>
<body>

<div class="layout">
  <!-- SIDEBAR -->
  <nav class="sidebar" id="sidebar">
    <div class="sidebar-logo">
      <img src="data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/4gHYSUNDX1BST0ZJTEUAAQEAAAHIAAAAAAQwAABtbnRyUkdCIFhZWiAH4AABAAEAAAAAAABhY3NwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQAA9tYAAQAAAADTLQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAlkZXNjAAAA8AAAACRyWFlaAAABFAAAABRnWFlaAAABKAAAABRiWFlaAAABPAAAABR3dHB0AAABUAAAABRyVFJDAAABZAAAAChnVFJDAAABZAAAAChiVFJDAAABZAAAAChjcHJ0AAABjAAAADxtbHVjAAAAAAAAAAEAAAAMZW5VUwAAAAgAAAAcAHMAUgBHAEJYWVogAAAAAAAAb6IAADj1AAADkFhZWiAAAAAAAABimQAAt4UAABjaWFlaIAAAAAAAACSgAAAPhAAAts9YWVogAAAAAAAA9tYAAQAAAADTLXBhcmEAAAAAAAQAAAACZmYAAPKnAAANWQAAE9AAAApbAAAAAAAAAABtbHVjAAAAAAAAAAEAAAAMZW5VUwAAACAAAAAcAEcAbwBvAGcAbABlACAASQBuAGMALgAgADIAMAAxADb/2wBDAAUDBAQEAwUEBAQFBQUGBwwIBwcHBw8LCwkMEQ8SEhEPERETFhwXExQaFRERGCEYGh0dHx8fExciJCIeJBweHx7/2wBDAQUFBQcGBw4ICA4eFBEUHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh7/wAARCABQANIDASIAAhEBAxEB/8QAGwABAAMBAQEBAAAAAAAAAAAAAAYHCAQFAwL/xABFEAABAwQAAwQECQgKAwEAAAABAgMEAAUGEQcSIQgTMUEUIlFxN2F1gZGhsbKzFSMyMzZCcnM0NVJidHaCkrTBQ1NV8P/EABoBAAIDAQEAAAAAAAAAAAAAAAADAgQFAQb/xAAvEQACAgIABAQEBQUAAAAAAAABAgADBBEFEiExE0FhcRQyscEiQoHR8BUjM5Hx/9oADAMBAAIRAxEAPwDZdKVF+K2RTMTwG5ZBb2Y70mL3XIh8EoPM6hB2AQfBR86kiF2CjuZ1QWIAkopVEcMOOdyv+WRLJfrXBaRNWGmXogWkoWf0dhSjsE9PLW6vem3470NyuJOytqzpopSoRxpy+44TiCLxbI8V99UtDBTISop5VJUd+qQd+qPOl11mxgq9zIqpY6Em9Kpzgvxhm5jkKrFerfEjyHG1OR3IvMEq5RspIUT11s735VcdSuoeluV+87ZW1Z00UpSlSEUpWaWu0NlDF37qbZ7M7EQ6UrS0hxDhSD5KKyAfmqxRi2X75PKNrpazfLNLUrmtU1i5WyLcYpJYlMoeaJ8SlSQR9RrpquRrpFRSlKIRSlKIRSotxXyObiWCXC/W9mO9JjFvkQ+CUHmcSk70QfAnzqsuF3HK5ZBlcWyX61wWUTF90y9EC08iz4BQUo7BPTprW6s14tllZsUdBGrS7KWHaXtSlKrRUUpXk5nc37LiV3u8ZDa34UN11lBOyoJ0SOqQd+qPOl11mxgq9zIqpY6Em9Kpzgvxhm5jkKrFerfEjyHG1OR3IvMEq5RspIUT11s735VcdSuoeluV+87ZW1Z00UpSlSEUpWaWu0NlDF37qbZ7M7EQ6UrS0hxDhSD5KKyAfmqxRi2X75PKNrpazfLNLUrmtU1i5WyLcYpJYlMoeaJ8SlSQR9RrpquRrpFRSlKIRSlKIRSotxXyObiWCXC/W9mO9JjFvkQ+CUHmcSk70QfAnzqsuF3HK5ZBlcWyX61wWUTF90y9EC08iz4BQUo7BPTprW6s14tllZsUdBGrS7KWHaXtSlKrRUUpXk5nc37LiV3u8ZDa34UN1uRrpFRSlKIRSlKIRSotxXyObiWCXC/W9mO9JjFvkQ+CUHmcSk70QfAnzqsuF3HK5ZBlcWyX61wWUTF90y9EC08iz4BQUo7BPTprW6s14tllZsUdBGrS7KWHaXtSlKrRUUpXk5nc37LiV3u8ZDa34UN1uRrpFRSlKIRSlKIQ==" alt="Stabolut" onerror="this.style.display='none'; this.nextElementSibling.style.display='block'">
      <div style="display:none; font-size:24px; font-weight:900; color:var(--purple); font-family:var(--font);">stabolut</div>
      <div class="sidebar-badge">$10M Round</div>
    </div>
    <div class="sidebar-nav">
      <div class="nav-label">Principal</div>
      <button class="nav-item active" onclick="showPage('dashboard', this)">
        <span class="icon">ğŸ“Š</span> Dashboard
      </button>
      <button class="nav-item" onclick="showPage('users', this)">
        <span class="icon">ğŸ‘¥</span> Usuarios / Clientes
      </button>
      <button class="nav-item" onclick="showPage('costs', this)">
        <span class="icon">ğŸ’°</span> Costes Operativos
      </button>
      <button class="nav-item" onclick="showPage('taxes', this)">
        <span class="icon">ğŸ›ï¸</span> Impuestos
      </button>
      <div class="nav-label">AnÃ¡lisis</div>
      <button class="nav-item" onclick="showPage('kpis', this)">
        <span class="icon">ğŸ¯</span> KPIs EstratÃ©gicos
      </button>
      <button class="nav-item" onclick="showPage('forecast', this)">
        <span class="icon">ğŸ“ˆ</span> Forecast 5 AÃ±os
      </button>
      <div class="nav-label">Exportar</div>
      <button class="nav-item" onclick="exportExcel()">
        <span class="icon">ğŸ“¥</span> Descargar Excel
      </button>
      <button class="nav-item" onclick="exportCSV()">
        <span class="icon">ğŸ“„</span> Descargar CSV
      </button>
      <button class="nav-item" onclick="window.print()">
        <span class="icon">ğŸ–¨ï¸</span> Imprimir / PDF
      </button>
    </div>
  </nav>

  <!-- MAIN CONTENT -->
  <div class="main">
    <!-- TOPBAR -->
    <div class="topbar">
      <div style="display:flex; align-items:center; gap:14px;">
        <button class="hamburger" onclick="toggleSidebar()">â˜°</button>
        <div>
          <div class="topbar-title" id="page-title">ğŸ“Š Overview Dashboard</div>
          <div class="topbar-subtitle">Scenario: <strong>$10M Round</strong> Â· Actualizado: Feb 2026 Â· <span id="last-updated"></span></div>
        </div>
      </div>
      <div class="topbar-actions">
        <span class="scenario-badge scenario-active">ğŸš€ $10M Round</span>
        <button class="btn btn-outline" onclick="recalculateAll()">ğŸ”„ Recalcular</button>
        <button class="btn btn-primary" onclick="exportExcel()">â¬‡ï¸ Exportar</button>
      </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         PAGE: DASHBOARD
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div id="page-dashboard" class="page active">

      <!-- KPI Cards -->
      <div class="kpi-grid">
        <div class="kpi-card purple">
          <span class="kpi-icon">ğŸ’</span>
          <div class="kpi-label">AuM / TVL Total (2026)</div>
          <div class="kpi-value" id="kpi-aum">$520M</div>
          <div class="kpi-delta pos" id="kpi-aum-delta">â†‘ +2.500% vs Q1</div>
        </div>
        <div class="kpi-card green">
          <span class="kpi-icon">ğŸ“ˆ</span>
          <div class="kpi-label">Protocol Revenue (2026)</div>
          <div class="kpi-value" id="kpi-revenue">$7.66M</div>
          <div class="kpi-delta pos">â†‘ Total aÃ±o base</div>
        </div>
        <div class="kpi-card red">
          <span class="kpi-icon">ğŸ’¸</span>
          <div class="kpi-label">Total OpEx (2026)</div>
          <div class="kpi-value" id="kpi-opex">$12.85M</div>
          <div class="kpi-delta neg">â†“ InversiÃ³n inicial</div>
        </div>
        <div class="kpi-card gold">
          <span class="kpi-icon">ğŸ¦</span>
          <div class="kpi-label">Net Income (2026)</div>
          <div class="kpi-value" id="kpi-net">-$5.19M</div>
          <div class="kpi-delta neg">â†“ AÃ±o de arranque</div>
        </div>
        <div class="kpi-card teal">
          <span class="kpi-icon">ğŸ’µ</span>
          <div class="kpi-label">Cash Balance (Q4 2026)</div>
          <div class="kpi-value" id="kpi-cash">-$186K</div>
          <div class="kpi-delta pos">+ Capital raise $10M</div>
        </div>
        <div class="kpi-card purple">
          <span class="kpi-icon">ğŸ‘¤</span>
          <div class="kpi-label">Usuarios Q4 2026</div>
          <div class="kpi-value" id="kpi-users">200</div>
          <div class="kpi-delta pos">â†‘ +900% vs Q1</div>
        </div>
      </div>

      <!-- Charts Row 1 -->
      <div class="charts-grid">
        <div class="chart-card" style="grid-column: span 2;">
          <div class="chart-header">
            <div>
              <div class="chart-title">ğŸ“ˆ Revenue vs OpEx vs Net Income â€” Trimestral</div>
              <div class="chart-sub">Valores en $000s Â· 2026â€“2029</div>
            </div>
          </div>
          <div class="chart-canvas"><canvas id="chartMain"></canvas></div>
        </div>
      </div>

      <div class="charts-grid">
        <div class="chart-card">
          <div class="chart-header">
            <div>
              <div class="chart-title">ğŸ¦ AuM / TVL Growth</div>
              <div class="chart-sub">$000s Â· crecimiento trimestral</div>
            </div>
          </div>
          <div class="chart-canvas"><canvas id="chartAum"></canvas></div>
        </div>
        <div class="chart-card">
          <div class="chart-header">
            <div>
              <div class="chart-title">ğŸ’° Desglose de Costes</div>
              <div class="chart-sub">DistribuciÃ³n anual 2026</div>
            </div>
          </div>
          <div class="chart-canvas"><canvas id="chartCosts"></canvas></div>
        </div>
        <div class="chart-card">
          <div class="chart-header">
            <div>
              <div class="chart-title">ğŸ’µ Cash Balance Evolution</div>
              <div class="chart-sub">Saldo acumulado trimestral $000s</div>
            </div>
          </div>
          <div class="chart-canvas"><canvas id="chartCash"></canvas></div>
        </div>
      </div>

      <!-- P&L Table -->
      <div class="section-title">ğŸ“‹ P&L Trimestral Completo</div>
      <div class="card" style="padding: 0;">
        <div class="table-wrap">
          <table id="main-pl-table">
            <thead>
              <tr>
                <th>Partida</th>
                <th>Q1 2026</th><th>Q2 2026</th><th>Q3 2026</th><th>Q4 2026</th>
                <th>Q1 2027</th><th>Q2 2027</th><th>Q3 2027</th><th>Q4 2027</th>
                <th>Q1 2028</th><th>Q2 2028</th><th>Q3 2028</th><th>Q4 2028</th>
                <th>Q1 2029</th><th>Q2 2029</th><th>Q3 2029</th><th>Q4 2029</th>
              </tr>
            </thead>
            <tbody id="pl-tbody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         PAGE: USUARIOS
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div id="page-users" class="page">
      <div class="alert-info">
        âœï¸ <strong>Modo ediciÃ³n:</strong> Modifica el nÃºmero de usuarios por trimestre. Los cambios recalcularÃ¡n automÃ¡ticamente AuM, Revenue y Net Income en todo el modelo.
      </div>

      <div class="card manual-input-card" style="margin-bottom: 24px;">
        <div class="card-title">ğŸ‘¥ Usuarios por Trimestre â€” Entrada Manual</div>
        <div class="inputs-grid" id="users-inputs"></div>
        <div class="recalc-notice">
          ğŸ”„ Cualquier cambio aquÃ­ actualiza automÃ¡ticamente el Dashboard, KPIs y Forecast. Pulsa <strong>Recalcular</strong> para confirmar.
        </div>
        <div style="margin-top: 16px; display: flex; gap: 10px; flex-wrap: wrap;">
          <button class="btn btn-primary" onclick="recalculateAll()">ğŸ”„ Recalcular Todo</button>
          <button class="btn btn-outline" onclick="resetUsers()">â†©ï¸ Restaurar Originales</button>
        </div>
      </div>

      <div class="section-title">ğŸ“Š EvoluciÃ³n de Usuarios & AuM</div>
      <div class="charts-grid">
        <div class="chart-card">
          <div class="chart-title" style="margin-bottom:16px;">ğŸ‘¤ Usuarios por Trimestre</div>
          <div class="chart-canvas"><canvas id="chartUsers"></canvas></div>
        </div>
        <div class="chart-card">
          <div class="chart-title" style="margin-bottom:16px;">ğŸ’ AuM por Usuario ($K medio)</div>
          <div class="chart-canvas"><canvas id="chartAumPerUser"></canvas></div>
        </div>
      </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         PAGE: COSTES
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div id="page-costs" class="page">
      <div class="alert-info">
        âœï¸ <strong>Gastos Manuales:</strong> Introduce ajustes o gastos extraordinarios. Se aÃ±adirÃ¡n al OpEx base y recalcularÃ¡n el Net Income y Cash Balance.
      </div>

      <div class="card manual-input-card" style="margin-bottom: 24px;">
        <div class="card-title">ğŸ’¸ Ajuste de Gastos por Trimestre (+ / -)</div>
        <div class="inputs-grid" id="cost-inputs"></div>
        <div class="recalc-notice">
          â„¹ï¸ Valores positivos = gastos adicionales. Valores negativos = ahorros/reducciÃ³n de costes. En $000s.
        </div>
        <div style="margin-top: 16px; display: flex; gap: 10px; flex-wrap: wrap;">
          <button class="btn btn-primary" onclick="recalculateAll()">ğŸ”„ Recalcular Todo</button>
          <button class="btn btn-ghost" onclick="resetCosts()">â†©ï¸ Limpiar Ajustes</button>
        </div>
      </div>

      <div class="section-title">ğŸ“Š Estructura de Costes</div>
      <div class="card" style="padding: 0;">
        <div class="table-wrap">
          <table id="costs-table">
            <thead>
              <tr>
                <th>Partida</th>
                <th>Q1 26</th><th>Q2 26</th><th>Q3 26</th><th>Q4 26</th>
                <th>Q1 27</th><th>Q2 27</th><th>Q3 27</th><th>Q4 27</th>
                <th>Q1 28</th><th>Q2 28</th><th>Q3 28</th><th>Q4 28</th>
                <th>TOTAL 26</th><th>TOTAL 27</th><th>TOTAL 28</th>
              </tr>
            </thead>
            <tbody id="costs-tbody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         PAGE: IMPUESTOS
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div id="page-taxes" class="page">
      <div class="alert-info">
        ğŸ›ï¸ <strong>Calculadora Fiscal:</strong> Configura los tipos impositivos por paÃ­s para calcular los pagos trimestrales de impuestos sobre el beneficio neto.
      </div>

      <div class="inputs-grid">
        <div class="card">
          <div class="card-title">ğŸ‡ªğŸ‡¸ EspaÃ±a â€” ParÃ¡metros Fiscales</div>
          <div class="input-group">
            <label class="input-label">Impuesto de Sociedades (%)</label>
            <div class="input-prefix"><span>%</span>
              <input class="input-field" type="number" id="tax-es-corp" value="25" min="0" max="100" step="0.5" oninput="recalculateTaxes()">
            </div>
          </div>
          <div class="input-group">
            <label class="input-label">IVA (%)</label>
            <div class="input-prefix"><span>%</span>
              <input class="input-field" type="number" id="tax-es-iva" value="21" min="0" max="30" step="0.5" oninput="recalculateTaxes()">
            </div>
          </div>
          <div class="input-group">
            <label class="input-label">RetenciÃ³n sobre dividendos (%)</label>
            <div class="input-prefix"><span>%</span>
              <input class="input-field" type="number" id="tax-es-div" value="19" min="0" max="30" step="0.5" oninput="recalculateTaxes()">
            </div>
          </div>
          <div class="input-group">
            <label class="input-label">Pagos fraccionados (P1, P3, P9, P11)</label>
            <select class="input-field" id="tax-es-method" onchange="recalculateTaxes()">
              <option value="0.18">MÃ©todo 1 â€” 18% cuota Ã­ntegra aÃ±o anterior</option>
              <option value="0.40" selected>MÃ©todo 2 â€” 40% resultado fiscal acumulado</option>
            </select>
          </div>
        </div>

        <div class="card">
          <div class="card-title">ğŸŒ Otro PaÃ­s â€” ParÃ¡metros Personalizados</div>
          <div class="input-group">
            <label class="input-label">PaÃ­s / JurisdicciÃ³n</label>
            <input class="input-field" type="text" id="tax-other-name" value="UAE / Cayman" oninput="recalculateTaxes()">
          </div>
          <div class="input-group">
            <label class="input-label">Corporate Tax (%)</label>
            <div class="input-prefix"><span>%</span>
              <input class="input-field" type="number" id="tax-other-corp" value="9" min="0" max="100" step="0.5" oninput="recalculateTaxes()">
            </div>
          </div>
          <div class="input-group">
            <label class="input-label">Withholding Tax (%)</label>
            <div class="input-prefix"><span>%</span>
              <input class="input-field" type="number" id="tax-other-wh" value="0" min="0" max="50" step="0.5" oninput="recalculateTaxes()">
            </div>
          </div>
          <div class="input-group">
            <label class="input-label">Tipo efectivo estimado (%)</label>
            <div class="input-prefix"><span>%</span>
              <input class="input-field" type="number" id="tax-other-eff" value="9" min="0" max="100" step="0.5" oninput="recalculateTaxes()">
            </div>
          </div>
        </div>
      </div>

      <div class="section-title">ğŸ“Š Pagos Trimestrales de Impuestos</div>
      <div class="card" style="padding: 0; margin-bottom: 24px;">
        <div class="table-wrap">
          <table id="tax-table">
            <thead>
              <tr>
                <th>Concepto</th>
                <th>Q1 2026</th><th>Q2 2026</th><th>Q3 2026</th><th>Q4 2026</th>
                <th>Q1 2027</th><th>Q2 2027</th><th>Q3 2027</th><th>Q4 2027</th>
                <th>Q1 2028</th><th>Q2 2028</th><th>Q3 2028</th><th>Q4 2028</th>
                <th>TOTAL 26</th><th>TOTAL 27</th><th>TOTAL 28</th>
              </tr>
            </thead>
            <tbody id="tax-tbody"></tbody>
          </table>
        </div>
      </div>

      <div class="charts-grid">
        <div class="chart-card">
          <div class="chart-title" style="margin-bottom:16px;">ğŸ›ï¸ Carga Fiscal Estimada Anual</div>
          <div class="chart-canvas"><canvas id="chartTax"></canvas></div>
        </div>
        <div class="chart-card">
          <div class="card-title" style="margin-bottom: 14px;">âš ï¸ Notas Fiscales Importantes</div>
          <div style="font-size:13px; color: var(--gray-700); line-height: 1.7;">
            <p>ğŸ‡ªğŸ‡¸ <strong>EspaÃ±a:</strong> Los pagos fraccionados se realizan en abril, octubre y diciembre (mod. 202). La liquidaciÃ³n definitiva en julio del aÃ±o siguiente (mod. 200).</p>
            <br>
            <p>ğŸ“‹ <strong>PÃ©rdidas:</strong> En 2026 el modelo genera pÃ©rdidas, por lo que no habrÃ¡ pago de IS. Las pÃ©rdidas se compensan con beneficios futuros (art. 26 LIS, lÃ­mite 70%).</p>
            <br>
            <p>ğŸŒ <strong>Internacional:</strong> Considerar convenios de doble imposiciÃ³n y rÃ©gimen ETVE para dividendos desde subsidiarias extranjeras.</p>
            <br>
            <p>ğŸ’¡ <strong>Crypto:</strong> Las operaciones con stablecoins pueden tributar como rendimientos del capital mobiliario o actividad econÃ³mica segÃºn la estructura societaria.</p>
          </div>
        </div>
      </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         PAGE: KPIs
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div id="page-kpis" class="page">
      <div class="kpi-grid" id="strategic-kpis"></div>

      <div class="section-title">ğŸ¯ KPIs por AÃ±o</div>
      <div class="card" style="padding:0; margin-bottom:24px;">
        <div class="table-wrap">
          <table id="kpis-table">
            <thead>
              <tr>
                <th>KPI</th><th>2026 Real</th><th>2027</th><th>2028</th><th>2029</th><th>YoY Growth</th>
              </tr>
            </thead>
            <tbody id="kpis-tbody"></tbody>
          </table>
        </div>
      </div>

      <div class="charts-grid">
        <div class="chart-card">
          <div class="chart-title" style="margin-bottom:16px;">ğŸ“Š EBITDA Margin Evolution</div>
          <div class="chart-canvas"><canvas id="chartEbitda"></canvas></div>
        </div>
        <div class="chart-card">
          <div class="chart-title" style="margin-bottom:16px;">ğŸ¯ Revenue Growth Rate</div>
          <div class="chart-canvas"><canvas id="chartGrowth"></canvas></div>
        </div>
      </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         PAGE: FORECAST 5 AÃ‘OS
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div id="page-forecast" class="page">
      <div class="alert-info">
        ğŸ“… Forecast completo 5 aÃ±os (2026â€“2030). Basado en datos reales hasta 2029 + proyecciÃ³n 2030 calculada.
      </div>

      <div class="kpi-grid" id="forecast-summary"></div>

      <div class="section-title">ğŸ“ˆ ProyecciÃ³n 5 AÃ±os â€” Revenue & Cash</div>
      <div class="chart-card" style="margin-bottom: 24px;">
        <div class="chart-canvas" style="height: 320px;"><canvas id="chartForecast5y"></canvas></div>
      </div>

      <div class="section-title">ğŸ“‹ Datos Anuales Completos</div>
      <div class="card" style="padding:0;">
        <div class="table-wrap">
          <table id="forecast-table">
            <thead>
              <tr>
                <th>MÃ©trica ($000s)</th><th>2026</th><th>2027</th><th>2028</th><th>2029</th><th>2030E</th>
              </tr>
            </thead>
            <tbody id="forecast-tbody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="footer-bar">
      <span>Â© 2026 Stabolut Â· Financial Model v3.0 Â· Confidencial</span>
      <span>ğŸ’¡ Datos en $000s Â· Escenario $10M Round</span>
    </div>
  </div>
</div>

<script>
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// DATA MODEL
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const quarters = ['Q1 2026','Q2 2026','Q3 2026','Q4 2026','Q1 2027','Q2 2027','Q3 2027','Q4 2027','Q1 2028','Q2 2028','Q3 2028','Q4 2028','Q1 2029','Q2 2029','Q3 2029','Q4 2029'];

// Base users (original)
const baseUsers = [20, 100, 200, 200, 600, 840, 1176, 1529, 1987, 2385, 2862, 3434, 3778, 4155, 4571, 5028];

// AuM per user ($K) â€” derived from data
const baseAuM = [20000, 100000, 200000, 200000, 600000, 840000, 1176000, 1528800, 1987440, 2384928, 2861914, 3434296, 3777726, 4155499, 4571048, 5028153];

const aprRates = [0.30, 0.30, 0.29, 0.29, 0.28, 0.27, 0.26, 0.25, 0.24, 0.23, 0.21, 0.20, 0.19, 0.18, 0.16, 0.16];
const baseRevenue = [299, 1485, 2940, 2940, 8460, 11542, 15566, 19426, 23887, 27242, 30643, 33823, 35259, 36430, 37224, 40027];

const baseCosts = {
  'Engineering & Dev':    [300,400,500,500,500,500,500,500,600,600,600,600,600,600,600,600],
  'BD & Partnerships':    [140,150,150,150,150,150,150,150,150,150,150,150,150,150,150,150],
  'Marketing & Growth':   [2000,1500,2000,2500,2500,2500,2500,2500,2000,2000,1500,1500,1500,1500,1500,1500],
  'Compliance & Legal':   [500,500,400,400,400,400,250,250,250,250,250,250,250,250,250,250],
  'Ops & Infrastructure': [120,140,150,170,190,200,200,200,200,200,200,200,200,200,200,200],
  'G&A':                  [30,40,50,60,70,70,70,70,70,70,70,70,70,70,70,70]
};

const capitalRaise = [5000,5000,0,0,0,0,0,0,0,0,0,0,0,0,0,0];
const ma = [-1000,-2000,-1000,-1000,-2000,-4000,-4000,-4000,-4000,-4000,-4000,-4000,-4000,-4000,-4000,-4000];

// Mutable state
let userAdjustments = new Array(16).fill(0);    // delta from base
let costAdjustments = new Array(16).fill(0);     // extra costs $K

let charts = {};

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// COMPUTED VALUES
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getUsers() {
  return baseUsers.map((u, i) => Math.max(0, u + userAdjustments[i]));
}

function getAuM() {
  const users = getUsers();
  // AuM scaled proportionally to user changes
  return users.map((u, i) => {
    const ratio = baseUsers[i] > 0 ? u / baseUsers[i] : 1;
    return Math.round(baseAuM[i] * ratio);
  });
}

function getRevenue() {
  const aum = getAuM();
  // Commission rate 20% of protocol revenue = AuM * APR * 20%
  return aum.map((a, i) => Math.round(a * aprRates[i] * 0.20 / 4));
}

function getBaseOpEx(i) {
  return Object.values(baseCosts).reduce((s, arr) => s + arr[i], 0);
}

function getOpEx() {
  return quarters.map((_, i) => getBaseOpEx(i) + costAdjustments[i]);
}

function getNetIncome() {
  const rev = getRevenue();
  const opex = getOpEx();
  return rev.map((r, i) => r - opex[i]);
}

function getCashBalance() {
  const net = getNetIncome();
  const cash = [];
  let prev = 0;
  for (let i = 0; i < 16; i++) {
    const balance = prev + net[i] + capitalRaise[i] + ma[i];
    cash.push(Math.round(balance));
    prev = balance;
  }
  return cash;
}

// Annual aggregates
function annualSum(arr, year) {
  // year 0=2026, 1=2027, 2=2028, 3=2029
  const s = year * 4;
  return arr.slice(s, s+4).reduce((a,b) => a+b, 0);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// NAVIGATION
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showPage(id, btn) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  document.getElementById('page-' + id).classList.add('active');
  if (btn) btn.classList.add('active');
  const titles = {
    dashboard: 'ğŸ“Š Overview Dashboard',
    users: 'ğŸ‘¥ Usuarios / Clientes',
    costs: 'ğŸ’° Costes Operativos',
    taxes: 'ğŸ›ï¸ Calculadora Fiscal',
    kpis: 'ğŸ¯ KPIs EstratÃ©gicos',
    forecast: 'ğŸ“ˆ Forecast 5 AÃ±os'
  };
  document.getElementById('page-title').textContent = titles[id] || id;
  if (id === 'taxes') recalculateTaxes();
}

function toggleSidebar() {
  document.getElementById('sidebar').classList.toggle('open');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// FORMAT
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function fmt(v, decimals=0) {
  if (v === null || v === undefined) return 'â€”';
  const abs = Math.abs(v);
  let s;
  if (abs >= 1000000) s = (v/1000000).toFixed(1) + 'M';
  else if (abs >= 1000) s = (v/1000).toFixed(0) + 'K';
  else s = v.toFixed(decimals);
  return (v < 0 ? '-$' : '$') + s;
}

function fmtK(v) {
  if (v === null) return 'â€”';
  const neg = v < 0;
  return (neg ? '(' : '') + '$' + Math.abs(Math.round(v)).toLocaleString() + (neg ? ')' : '');
}

function cls(v) { return v >= 0 ? 'td-pos' : 'td-neg'; }

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// BUILD INPUTS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildUserInputs() {
  const container = document.getElementById('users-inputs');
  container.innerHTML = '';
  quarters.forEach((q, i) => {
    const div = document.createElement('div');
    div.innerHTML = `
      <div class="input-group">
        <label class="input-label">${q}</label>
        <input class="input-field" type="number" id="u${i}" value="${baseUsers[i] + userAdjustments[i]}" min="0" step="10" oninput="onUserChange(${i}, this.value)">
      </div>`;
    container.appendChild(div);
  });
}

function buildCostInputs() {
  const container = document.getElementById('cost-inputs');
  container.innerHTML = '';
  quarters.forEach((q, i) => {
    const div = document.createElement('div');
    div.innerHTML = `
      <div class="input-group">
        <label class="input-label">${q} â€” Ajuste $K</label>
        <div class="input-prefix"><span>$</span>
          <input class="input-field" type="number" id="c${i}" value="${costAdjustments[i]}" step="10" oninput="onCostChange(${i}, this.value)">
        </div>
      </div>`;
    container.appendChild(div);
  });
}

function onUserChange(i, v) {
  const val = parseInt(v) || 0;
  userAdjustments[i] = val - baseUsers[i];
  recalculateAll();
}

function onCostChange(i, v) {
  costAdjustments[i] = parseFloat(v) || 0;
  recalculateAll();
}

function resetUsers() {
  userAdjustments = new Array(16).fill(0);
  buildUserInputs();
  recalculateAll();
}

function resetCosts() {
  costAdjustments = new Array(16).fill(0);
  buildCostInputs();
  recalculateAll();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// UPDATE KPI CARDS (Dashboard)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateKPICards() {
  const aum = getAuM();
  const rev = getRevenue();
  const opex = getOpEx();
  const net = getNetIncome();
  const cash = getCashBalance();
  const users = getUsers();

  const totalAuM2026 = aum.slice(0,4).reduce((a,b)=>a+b,0);
  const totalRev2026 = rev.slice(0,4).reduce((a,b)=>a+b,0);
  const totalOpEx2026 = opex.slice(0,4).reduce((a,b)=>a+b,0);
  const totalNet2026 = net.slice(0,4).reduce((a,b)=>a+b,0);

  document.getElementById('kpi-aum').textContent = fmt(totalAuM2026);
  document.getElementById('kpi-revenue').textContent = fmt(totalRev2026);
  document.getElementById('kpi-opex').textContent = fmt(totalOpEx2026);
  document.getElementById('kpi-net').textContent = fmt(totalNet2026);
  document.getElementById('kpi-cash').textContent = fmtK(cash[3]);
  document.getElementById('kpi-users').textContent = users[3].toLocaleString();

  const rev2027 = rev.slice(4,8).reduce((a,b)=>a+b,0);
  const delta = ((rev2027 - totalRev2026) / Math.abs(totalRev2026) * 100).toFixed(0);
  document.getElementById('kpi-aum-delta').textContent = `â†‘ ${delta}% Revenue Growth 27`;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// UPDATE TABLES
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updatePLTable() {
  const aum = getAuM();
  const rev = getRevenue();
  const opex = getOpEx();
  const net = getNetIncome();
  const cash = getCashBalance();

  const rows = [
    { label: 'AuM / TVL ($K)', values: aum, cls: 'td-purple', prefix: '' },
    { label: 'APR (%)', values: aprRates.map(r => (r*100).toFixed(0)+'%'), cls: '' },
    { label: 'âœ… Protocol Revenue', values: rev, cls: 'td-pos' },
    { label: 'Total OpEx', values: opex, cls: 'td-neg' },
    { label: 'ğŸ“Š NET INCOME', values: net, cls: null, fn: cls },
    { label: 'Capital Raise', values: capitalRaise, cls: 'td-purple' },
    { label: 'M&A', values: ma, cls: 'td-neg' },
    { label: 'ğŸ’µ Cash Balance', values: cash, cls: null, fn: cls }
  ];

  const tbody = document.getElementById('pl-tbody');
  tbody.innerHTML = rows.map(r => {
    const cells = r.values.map((v, i) => {
      const c = r.fn ? r.fn(v) : r.cls;
      const disp = typeof v === 'string' ? v : fmtK(v);
      return `<td class="${c}">${disp}</td>`;
    }).join('');
    return `<tr><td>${r.label}</td>${cells}</tr>`;
  }).join('');
}

function updateCostsTable() {
  const tbody = document.getElementById('costs-tbody');
  const rows = Object.entries(baseCosts).map(([name, vals]) => {
    const t26 = vals.slice(0,4).reduce((a,b)=>a+b,0);
    const t27 = vals.slice(4,8).reduce((a,b)=>a+b,0);
    const t28 = vals.slice(8,12).reduce((a,b)=>a+b,0);
    const cells = vals.slice(0,12).map(v => `<td>${fmtK(v)}</td>`).join('');
    return `<tr><td>${name}</td>${cells}<td class="td-neg">${fmtK(t26)}</td><td class="td-neg">${fmtK(t27)}</td><td class="td-neg">${fmtK(t28)}</td></tr>`;
  });

  // Adjustments row
  const adjCells = costAdjustments.slice(0,12).map((v,i) => 
    `<td class="${v>0?'td-neg':v<0?'td-pos':''}">${v!==0?fmtK(v):'â€”'}</td>`).join('');
  const adjT26 = costAdjustments.slice(0,4).reduce((a,b)=>a+b,0);
  const adjT27 = costAdjustments.slice(4,8).reduce((a,b)=>a+b,0);
  const adjT28 = costAdjustments.slice(8,12).reduce((a,b)=>a+b,0);
  rows.push(`<tr style="background:var(--purple-pale)"><td>âœï¸ Ajustes Manuales</td>${adjCells}<td class="td-neg">${fmtK(adjT26)}</td><td class="td-neg">${fmtK(adjT27)}</td><td class="td-neg">${fmtK(adjT28)}</td></tr>`);

  // Totals
  const opex = getOpEx();
  const t26 = opex.slice(0,4).reduce((a,b)=>a+b,0);
  const t27 = opex.slice(4,8).reduce((a,b)=>a+b,0);
  const t28 = opex.slice(8,12).reduce((a,b)=>a+b,0);
  const totCells = opex.slice(0,12).map(v => `<td class="td-neg"><strong>${fmtK(v)}</strong></td>`).join('');
  rows.push(`<tr style="font-weight:700; border-top: 2px solid var(--purple-light);"><td>TOTAL OpEx</td>${totCells}<td class="td-neg">${fmtK(t26)}</td><td class="td-neg">${fmtK(t27)}</td><td class="td-neg">${fmtK(t28)}</td></tr>`);

  tbody.innerHTML = rows.join('');
}

function updateKPIsTable() {
  const rev = getRevenue();
  const opex = getOpEx();
  const net = getNetIncome();
  const aum = getAuM();
  const users = getUsers();
  const cash = getCashBalance();

  const years = [0,1,2,3].map(y => ({
    rev: annualSum(rev, y),
    opex: annualSum(opex, y),
    net: annualSum(net, y),
    aum: Math.max(...aum.slice(y*4, y*4+4)),
    users: Math.max(...users.slice(y*4, y*4+4)),
    cash: cash[y*4+3]
  }));

  const kpis = [
    { label: 'Total Revenue ($K)', vals: years.map(y => fmtK(y.rev)), growth: true, cls: 'td-purple' },
    { label: 'Total OpEx ($K)', vals: years.map(y => fmtK(y.opex)), growth: false, cls: 'td-neg' },
    { label: 'Net Income ($K)', vals: years.map(y => fmtK(y.net)), growth: true, clsFn: (i) => years[i].net >= 0 ? 'td-pos' : 'td-neg' },
    { label: 'EBITDA Margin (%)', vals: years.map(y => y.rev > 0 ? (y.net/y.rev*100).toFixed(1)+'%' : 'N/A'), growth: true },
    { label: 'Max AuM/TVL ($K)', vals: years.map(y => fmtK(y.aum)), growth: true, cls: 'td-purple' },
    { label: 'Peak Users', vals: years.map(y => y.users.toLocaleString()), growth: true },
    { label: 'Cash Balance ($K)', vals: years.map(y => fmtK(y.cash)), growth: true, clsFn: (i) => years[i].cash >= 0 ? 'td-pos' : 'td-neg' }
  ];

  const tbody = document.getElementById('kpis-tbody');
  tbody.innerHTML = kpis.map(k => {
    const cells = k.vals.map((v,i) => {
      const c = k.clsFn ? k.clsFn(i) : (k.cls || '');
      return `<td class="${c}">${v}</td>`;
    }).join('');
    // YoY from 26 to 27
    let yoy = 'â€”';
    if (k.growth && years[0].rev > 0) {
      const v0 = k.label.includes('Revenue') ? years[0].rev : (k.label.includes('Users') ? years[0].users : years[0].net);
      const v1 = k.label.includes('Revenue') ? years[1].rev : (k.label.includes('Users') ? years[1].users : years[1].net);
      if (v0 !== 0) yoy = `<span class="${v1>v0?'td-pos':'td-neg'}">${((v1-v0)/Math.abs(v0)*100).toFixed(0)}%</span>`;
    }
    return `<tr><td>${k.label}</td>${cells}<td>${yoy}</td></tr>`;
  }).join('');

  // Strategic KPI cards
  const skpis = document.getElementById('strategic-kpis');
  const breakeven = net.findIndex(v => v > 0);
  skpis.innerHTML = `
    <div class="kpi-card purple"><span class="kpi-icon">ğŸš€</span>
      <div class="kpi-label">Breakeven Quarter</div>
      <div class="kpi-value">${breakeven >= 0 ? quarters[breakeven] : 'TBD'}</div>
      <div class="kpi-delta pos">Primer quarter positivo</div>
    </div>
    <div class="kpi-card green"><span class="kpi-icon">ğŸ’°</span>
      <div class="kpi-label">Revenue 2027</div>
      <div class="kpi-value">${fmt(years[1].rev)}</div>
      <div class="kpi-delta pos">â†‘ vs 2026 +${((years[1].rev-years[0].rev)/Math.abs(years[0].rev)*100).toFixed(0)}%</div>
    </div>
    <div class="kpi-card gold"><span class="kpi-icon">ğŸ¯</span>
      <div class="kpi-label">Max Cash Balance</div>
      <div class="kpi-value">${fmt(Math.max(...cash))}</div>
      <div class="kpi-delta pos">En ${quarters[cash.indexOf(Math.max(...cash))]}</div>
    </div>
    <div class="kpi-card teal"><span class="kpi-icon">ğŸ‘¥</span>
      <div class="kpi-label">Usuarios 2029</div>
      <div class="kpi-value">${years[3].users.toLocaleString()}</div>
      <div class="kpi-delta pos">â†‘ +${((years[3].users-years[0].users)/years[0].users*100).toFixed(0)}% vs 2026</div>
    </div>`;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// TAX CALCULATOR
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function recalculateTaxes() {
  const taxES = parseFloat(document.getElementById('tax-es-corp').value) / 100 || 0.25;
  const methodES = parseFloat(document.getElementById('tax-es-method').value) || 0.40;
  const taxOther = parseFloat(document.getElementById('tax-other-eff').value) / 100 || 0.09;

  const net = getNetIncome();
  // Tax only on positive quarters
  const taxPayES = net.map(v => v > 0 ? -(v * taxES * methodES) : 0);
  const taxPayOther = net.map(v => v > 0 ? -(v * taxOther) : 0);
  const netAfterTax = net.map((v, i) => v + taxPayES[i]);

  const tbody = document.getElementById('tax-tbody');
  const rows = [
    { label: 'Net Income (pre-tax) $K', vals: net, clsFn: v => v >= 0 ? 'td-pos' : 'td-neg' },
    { label: 'ğŸ‡ªğŸ‡¸ IS Pago Fraccionado', vals: taxPayES, clsFn: v => 'td-neg' },
    { label: 'ğŸŒ Tax Alternativo', vals: taxPayOther, clsFn: v => 'td-neg' },
    { label: 'âœ… Net Income post-tax', vals: netAfterTax, clsFn: v => v >= 0 ? 'td-pos' : 'td-neg' }
  ];

  tbody.innerHTML = rows.map(r => {
    const cells = r.vals.slice(0,12).map(v => `<td class="${r.clsFn(v)}">${v !== 0 ? fmtK(Math.round(v)) : 'â€”'}</td>`).join('');
    const t26 = Math.round(r.vals.slice(0,4).reduce((a,b)=>a+b,0));
    const t27 = Math.round(r.vals.slice(4,8).reduce((a,b)=>a+b,0));
    const t28 = Math.round(r.vals.slice(8,12).reduce((a,b)=>a+b,0));
    return `<tr><td>${r.label}</td>${cells}<td class="${r.clsFn(t26)}">${fmtK(t26)}</td><td class="${r.clsFn(t27)}">${fmtK(t27)}</td><td class="${r.clsFn(t28)}">${fmtK(t28)}</td></tr>`;
  }).join('');

  updateTaxChart(taxPayES, taxPayOther);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// FORECAST TABLE
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateForecastTable() {
  const rev = getRevenue();
  const opex = getOpEx();
  const net = getNetIncome();
  const aum = getAuM();
  const users = getUsers();
  const cash = getCashBalance();

  // Project 2030 (5% growth on 2029 revenue, same opex structure)
  const rev29 = annualSum(rev, 3);
  const rev30 = Math.round(rev29 * 1.30); // 30% growth
  const opex30 = Math.round(annualSum(opex, 3) * 1.05);
  const net30 = rev30 - opex30;
  const cash30 = cash[15] + net30 + ma[15]*4;
  const aum30 = Math.round(Math.max(...aum.slice(12)) * 1.40);
  const users30 = Math.round(Math.max(...users.slice(12)) * 1.35);

  const metrics = [
    { label: 'ğŸ’ AuM/TVL Peak ($K)', vals: [0,1,2,3].map(y=>Math.max(...aum.slice(y*4,y*4+4))).concat([aum30]), clsFn: ()=>'td-purple' },
    { label: 'ğŸ“ˆ Protocol Revenue ($K)', vals: [0,1,2,3].map(y=>annualSum(rev,y)).concat([rev30]), clsFn: ()=>'td-pos' },
    { label: 'ğŸ’¸ Total OpEx ($K)', vals: [0,1,2,3].map(y=>annualSum(opex,y)).concat([opex30]), clsFn: ()=>'td-neg' },
    { label: 'ğŸ“Š Net Income ($K)', vals: [0,1,2,3].map(y=>annualSum(net,y)).concat([net30]), clsFn: v=>v>=0?'td-pos':'td-neg' },
    { label: 'ğŸ’µ Cash Balance ($K)', vals: [cash[3],cash[7],cash[11],cash[15],cash30], clsFn: v=>v>=0?'td-pos':'td-neg' },
    { label: 'ğŸ‘¥ Peak Users', vals: [0,1,2,3].map(y=>Math.max(...users.slice(y*4,y*4+4))).concat([users30]), clsFn: ()=>'' },
    { label: 'EBITDA Margin (%)', vals: [0,1,2,3].map(y=>{const r=annualSum(rev,y); const n=annualSum(net,y); return r>0?(n/r*100).toFixed(1)+'%':'N/A';}).concat([(net30/rev30*100).toFixed(1)+'%']), clsFn: ()=>'' }
  ];

  const tbody = document.getElementById('forecast-tbody');
  tbody.innerHTML = metrics.map(m => {
    const cells = m.vals.map((v,i) => {
      const c = m.clsFn(typeof v === 'string' ? 0 : v);
      const disp = typeof v === 'string' ? v : (typeof v === 'number' && Math.abs(v) < 10 ? v : (typeof v === 'number' ? fmtK(v) : v));
      return `<td class="${c}">${disp}</td>`;
    }).join('');
    return `<tr><td>${m.label}</td>${cells}</tr>`;
  }).join('');

  // Summary KPIs
  const summary = document.getElementById('forecast-summary');
  summary.innerHTML = `
    <div class="kpi-card purple"><span class="kpi-icon">ğŸ†</span>
      <div class="kpi-label">Revenue Total 5Y</div>
      <div class="kpi-value">${fmt([0,1,2,3].map(y=>annualSum(rev,y)).reduce((a,b)=>a+b,0)+rev30)}</div>
    </div>
    <div class="kpi-card green"><span class="kpi-icon">ğŸ’°</span>
      <div class="kpi-label">Net Income 2030E</div>
      <div class="kpi-value">${fmt(net30)}</div>
      <div class="kpi-delta pos">â†‘ ProyecciÃ³n +30%</div>
    </div>
    <div class="kpi-card gold"><span class="kpi-icon">ğŸ’</span>
      <div class="kpi-label">AuM 2030E</div>
      <div class="kpi-value">${fmt(aum30)}</div>
    </div>
    <div class="kpi-card teal"><span class="kpi-icon">ğŸ‘¥</span>
      <div class="kpi-label">Usuarios 2030E</div>
      <div class="kpi-value">${users30.toLocaleString()}</div>
    </div>`;

  updateForecast5yChart([0,1,2,3].map(y=>annualSum(rev,y)).concat([rev30]),
    [0,1,2,3].map(y=>annualSum(net,y)).concat([net30]),
    [cash[3],cash[7],cash[11],cash[15],cash30]);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// CHARTS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const chartColors = {
  purple: 'rgba(123, 47, 190, 1)',
  purpleA: 'rgba(123, 47, 190, 0.15)',
  green: 'rgba(39, 174, 96, 1)',
  greenA: 'rgba(39, 174, 96, 0.15)',
  red: 'rgba(231, 76, 60, 1)',
  redA: 'rgba(231, 76, 60, 0.15)',
  gold: 'rgba(243, 156, 18, 1)',
  goldA: 'rgba(243, 156, 18, 0.15)',
  teal: 'rgba(26, 188, 156, 1)',
  tealA: 'rgba(26, 188, 156, 0.15)'
};

const defaultChartOpts = {
  responsive: true,
  maintainAspectRatio: false,
  plugins: { legend: { labels: { font: { family: 'DM Sans', size: 12 }, usePointStyle: true } } },
  scales: {
    x: { grid: { color: 'rgba(0,0,0,0.05)' }, ticks: { font: { size: 11 } } },
    y: { grid: { color: 'rgba(0,0,0,0.05)' }, ticks: { font: { size: 11 }, callback: v => '$'+Math.round(v/1000)+'K' } }
  }
};

function destroyChart(id) {
  if (charts[id]) { charts[id].destroy(); delete charts[id]; }
}

function updateMainChart() {
  destroyChart('main');
  const rev = getRevenue();
  const opex = getOpEx();
  const net = getNetIncome();
  const ctx = document.getElementById('chartMain').getContext('2d');
  charts['main'] = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: quarters.map(q => q.replace(' ','\n')),
      datasets: [
        { label: 'Revenue', data: rev, backgroundColor: chartColors.greenA, borderColor: chartColors.green, borderWidth: 2, borderRadius: 4 },
        { label: 'OpEx', data: opex.map(v => -v), backgroundColor: chartColors.redA, borderColor: chartColors.red, borderWidth: 2, borderRadius: 4 },
        { label: 'Net Income', data: net, type: 'line', borderColor: chartColors.purple, backgroundColor: chartColors.purpleA, fill: true, tension: 0.4, pointBackgroundColor: chartColors.purple, pointRadius: 3 }
      ]
    },
    options: { ...defaultChartOpts, interaction: { mode: 'index' } }
  });
}

function updateAuMChart() {
  destroyChart('aum');
  const aum = getAuM();
  const ctx = document.getElementById('chartAum').getContext('2d');
  charts['aum'] = new Chart(ctx, {
    type: 'line',
    data: {
      labels: quarters.map(q => q.replace(' ','\n')),
      datasets: [{
        label: 'AuM/TVL', data: aum,
        borderColor: chartColors.purple, backgroundColor: chartColors.purpleA,
        fill: true, tension: 0.4, pointBackgroundColor: chartColors.purple, pointRadius: 3
      }]
    },
    options: { ...defaultChartOpts, scales: { ...defaultChartOpts.scales, y: { ...defaultChartOpts.scales.y, ticks: { callback: v => '$'+Math.round(v/1000)+'K' } } } }
  });
}

function updateCostsChart() {
  destroyChart('costs');
  const ctx = document.getElementById('chartCosts').getContext('2d');
  const names = Object.keys(baseCosts);
  const vals = names.map(n => baseCosts[n].slice(0,4).reduce((a,b)=>a+b,0));
  charts['costs'] = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: names,
      datasets: [{ data: vals, backgroundColor: ['rgba(123,47,190,0.8)','rgba(39,174,96,0.8)','rgba(231,76,60,0.8)','rgba(243,156,18,0.8)','rgba(26,188,156,0.8)','rgba(52,152,219,0.8)'], borderWidth: 2, borderColor: '#fff' }]
    },
    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { font: { size: 11 } } } } }
  });
}

function updateCashChart() {
  destroyChart('cash');
  const cash = getCashBalance();
  const ctx = document.getElementById('chartCash').getContext('2d');
  charts['cash'] = new Chart(ctx, {
    type: 'line',
    data: {
      labels: quarters.map(q => q.replace(' ','\n')),
      datasets: [{
        label: 'Cash Balance', data: cash,
        borderColor: chartColors.teal, backgroundColor: chartColors.tealA,
        fill: true, tension: 0.4, pointBackgroundColor: cash.map(v => v >= 0 ? chartColors.teal : chartColors.red), pointRadius: 4
      }]
    },
    options: { ...defaultChartOpts }
  });
}

function updateUsersChart() {
  destroyChart('users');
  destroyChart('aumperuser');
  const users = getUsers();
  const aum = getAuM();
  const aumPerUser = users.map((u, i) => u > 0 ? Math.round(aum[i]/u) : 0);

  const ctx1 = document.getElementById('chartUsers').getContext('2d');
  charts['users'] = new Chart(ctx1, {
    type: 'bar',
    data: {
      labels: quarters.map(q => q.replace(' ','\n')),
      datasets: [{ label: 'Usuarios', data: users, backgroundColor: chartColors.purpleA, borderColor: chartColors.purple, borderWidth: 2, borderRadius: 6 }]
    },
    options: { ...defaultChartOpts, scales: { ...defaultChartOpts.scales, y: { ...defaultChartOpts.scales.y, ticks: { callback: v => v.toLocaleString() } } } }
  });

  const ctx2 = document.getElementById('chartAumPerUser').getContext('2d');
  charts['aumperuser'] = new Chart(ctx2, {
    type: 'line',
    data: {
      labels: quarters.map(q => q.replace(' ','\n')),
      datasets: [{ label: 'AuM/Usuario $K', data: aumPerUser, borderColor: chartColors.gold, backgroundColor: chartColors.goldA, fill: true, tension: 0.4, pointBackgroundColor: chartColors.gold, pointRadius: 4 }]
    },
    options: { ...defaultChartOpts, scales: { ...defaultChartOpts.scales, y: { ...defaultChartOpts.scales.y, ticks: { callback: v => '$'+v.toLocaleString() } } } }
  });
}

function updateKPICharts() {
  destroyChart('ebitda'); destroyChart('growth');
  const rev = getRevenue();
  const net = getNetIncome();
  const years = ['2026','2027','2028','2029'];
  const ebitdaM = [0,1,2,3].map(y => { const r = annualSum(rev,y); const n = annualSum(net,y); return r > 0 ? parseFloat((n/r*100).toFixed(1)) : 0; });
  const revY = [0,1,2,3].map(y => annualSum(rev,y));
  const growthR = revY.map((v,i) => i>0 ? parseFloat(((v-revY[i-1])/Math.abs(revY[i-1])*100).toFixed(1)) : 0);

  const ctx1 = document.getElementById('chartEbitda').getContext('2d');
  charts['ebitda'] = new Chart(ctx1, {
    type: 'bar',
    data: {
      labels: years,
      datasets: [{ label: 'EBITDA Margin %', data: ebitdaM, backgroundColor: ebitdaM.map(v=>v>=0?chartColors.greenA:chartColors.redA), borderColor: ebitdaM.map(v=>v>=0?chartColors.green:chartColors.red), borderWidth: 2, borderRadius: 8 }]
    },
    options: { ...defaultChartOpts, scales: { ...defaultChartOpts.scales, y: { ...defaultChartOpts.scales.y, ticks: { callback: v => v+'%' } } } }
  });

  const ctx2 = document.getElementById('chartGrowth').getContext('2d');
  charts['growth'] = new Chart(ctx2, {
    type: 'line',
    data: {
      labels: years,
      datasets: [{ label: 'Revenue YoY Growth %', data: growthR, borderColor: chartColors.purple, backgroundColor: chartColors.purpleA, fill: true, tension: 0.4, pointBackgroundColor: chartColors.purple, pointRadius: 6 }]
    },
    options: { ...defaultChartOpts, scales: { ...defaultChartOpts.scales, y: { ...defaultChartOpts.scales.y, ticks: { callback: v => v+'%' } } } }
  });
}

function updateTaxChart(taxES, taxOther) {
  destroyChart('tax');
  const years = ['2026','2027','2028','2029'];
  const es = [0,1,2,3].map(y => Math.abs(Math.round(annualSum(taxES,y))));
  const ot = [0,1,2,3].map(y => Math.abs(Math.round(annualSum(taxOther,y))));
  const ctx = document.getElementById('chartTax').getContext('2d');
  charts['tax'] = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: years,
      datasets: [
        { label: 'ğŸ‡ªğŸ‡¸ IS EspaÃ±a', data: es, backgroundColor: chartColors.purpleA, borderColor: chartColors.purple, borderWidth: 2, borderRadius: 6 },
        { label: 'ğŸŒ Alternativo', data: ot, backgroundColor: chartColors.goldA, borderColor: chartColors.gold, borderWidth: 2, borderRadius: 6 }
      ]
    },
    options: { ...defaultChartOpts }
  });
}

function updateForecast5yChart(revY, netY, cashY) {
  destroyChart('forecast5y');
  const labels = ['2026','2027','2028','2029','2030E'];
  const ctx = document.getElementById('chartForecast5y').getContext('2d');
  charts['forecast5y'] = new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [
        { label: 'Revenue $K', data: revY, backgroundColor: chartColors.greenA, borderColor: chartColors.green, borderWidth: 2, borderRadius: 6 },
        { label: 'Net Income $K', data: netY, backgroundColor: netY.map(v=>v>=0?chartColors.purpleA:chartColors.redA), borderColor: netY.map(v=>v>=0?chartColors.purple:chartColors.red), borderWidth: 2, borderRadius: 6 },
        { label: 'Cash Balance $K', data: cashY, type: 'line', borderColor: chartColors.teal, backgroundColor: 'transparent', tension: 0.4, pointBackgroundColor: cashY.map(v=>v>=0?chartColors.teal:chartColors.red), pointRadius: 6 }
      ]
    },
    options: { ...defaultChartOpts, interaction: { mode: 'index' } }
  });
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// MASTER RECALCULATE
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function recalculateAll() {
  updateKPICards();
  updatePLTable();
  updateCostsTable();
  updateKPIsTable();
  updateForecastTable();
  updateMainChart();
  updateAuMChart();
  updateCostsChart();
  updateCashChart();
  updateUsersChart();
  updateKPICharts();
  recalculateTaxes();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// EXPORT
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function exportCSV() {
  const rev = getRevenue();
  const opex = getOpEx();
  const net = getNetIncome();
  const cash = getCashBalance();
  const aum = getAuM();
  const users = getUsers();

  let csv = 'Stabolut Financial Model â€” $10M Round\n\n';
  csv += 'Quarter,' + quarters.join(',') + '\n';
  csv += 'Users,' + users.join(',') + '\n';
  csv += 'AuM/TVL ($K),' + aum.join(',') + '\n';
  csv += 'APR (%),' + aprRates.map(r=>(r*100).toFixed(0)+'%').join(',') + '\n';
  csv += 'Protocol Revenue ($K),' + rev.join(',') + '\n';
  csv += 'Total OpEx ($K),' + opex.join(',') + '\n';
  csv += 'Net Income ($K),' + net.join(',') + '\n';
  csv += 'Capital Raise ($K),' + capitalRaise.join(',') + '\n';
  csv += 'M&A ($K),' + ma.join(',') + '\n';
  csv += 'Cash Balance ($K),' + cash.join(',') + '\n';
  Object.entries(baseCosts).forEach(([k,v]) => { csv += k + ' ($K),' + v.join(',') + '\n'; });

  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'Stabolut_Financial_Model.csv';
  a.click();
}

function exportExcel() {
  const rev = getRevenue();
  const opex = getOpEx();
  const net = getNetIncome();
  const cash = getCashBalance();
  const aum = getAuM();
  const users = getUsers();

  const wb = XLSX.utils.book_new();

  // Overview sheet
  const overviewData = [
    ['STABOLUT â€” FINANCIAL MODEL Â· $10M Round Scenario', '', '', ...new Array(13).fill('')],
    [],
    ['Metric ($000s)', ...quarters],
    ['Users', ...users],
    ['AuM / TVL', ...aum],
    ['APR (%)', ...aprRates.map(r=>(r*100).toFixed(0)+'%')],
    ['Protocol Revenue', ...rev],
    ['Total OpEx', ...opex],
    ['Net Income', ...net],
    ['Capital Raise', ...capitalRaise],
    ['M&A', ...ma],
    ['ENDING CASH BALANCE', ...cash]
  ];
  const ws1 = XLSX.utils.aoa_to_sheet(overviewData);
  XLSX.utils.book_append_sheet(wb, ws1, 'Overview');

  // Costs sheet
  const costsData = [['Cost Item ($000s)', ...quarters]];
  Object.entries(baseCosts).forEach(([k,v]) => costsData.push([k, ...v]));
  costsData.push(['Manual Adjustments', ...costAdjustments]);
  costsData.push(['TOTAL OpEx', ...opex]);
  const ws2 = XLSX.utils.aoa_to_sheet(costsData);
  XLSX.utils.book_append_sheet(wb, ws2, 'Costs');

  // Users sheet
  const usersData = [['Quarter', ...quarters], ['Users', ...users], ['AuM/TVL', ...aum]];
  const ws3 = XLSX.utils.aoa_to_sheet(usersData);
  XLSX.utils.book_append_sheet(wb, ws3, 'Users');

  // Annual summary
  const annData = [
    ['Annual Summary ($000s)', '2026', '2027', '2028', '2029'],
    ['Revenue', ...[0,1,2,3].map(y=>annualSum(rev,y))],
    ['OpEx', ...[0,1,2,3].map(y=>annualSum(opex,y))],
    ['Net Income', ...[0,1,2,3].map(y=>annualSum(net,y))],
    ['Cash Balance (YE)', cash[3], cash[7], cash[11], cash[15]]
  ];
  const ws4 = XLSX.utils.aoa_to_sheet(annData);
  XLSX.utils.book_append_sheet(wb, ws4, 'Annual Summary');

  XLSX.writeFile(wb, 'Stabolut_Financial_Model.xlsx');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// INIT
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.addEventListener('DOMContentLoaded', () => {
  document.getElementById('last-updated').textContent = new Date().toLocaleDateString('es-ES');
  buildUserInputs();
  buildCostInputs();
  recalculateAll();
});
</script>
</body>
</html>
